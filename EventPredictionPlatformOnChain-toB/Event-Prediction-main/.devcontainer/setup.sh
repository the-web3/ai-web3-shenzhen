#!/bin/bash
set -e

# Detect if running in interactive terminal
if [ -t 1 ]; then
    INTERACTIVE=true
else
    INTERACTIVE=false
fi

# Progress indicator functions
show_spinner() {
    local pid=$1
    local message=$2

    if [ "$INTERACTIVE" = true ]; then
        local spin='â ‹â ™â ¹â ¸â ¼â ´â ¦â §â ‡â '
        local i=0
        tput civis 2>/dev/null || true
        while kill -0 $pid 2>/dev/null; do
            i=$(( (i+1) %10 ))
            printf "\r${spin:$i:1} $message"
            sleep 0.1
        done
        printf "\r"
        tput cnorm 2>/dev/null || true
    else
        # Non-interactive: just wait for process to complete
        wait $pid 2>/dev/null || true
    fi
}

show_progress() {
    local current=$1
    local total=$2
    local message=$3

    if [ "$INTERACTIVE" = true ]; then
        local width=30
        local percentage=$((current * 100 / total))
        local filled=$((width * current / total))

        printf "\r["
        printf "%${filled}s" | tr ' ' '='
        printf "%$((width - filled))s"
        printf "] %3d%% (%d/%d) %s" $percentage $current $total "$message"
    else
        # Non-interactive: print simple progress
        echo "  [$current/$total] $message"
    fi
}

# Cleanup function
cleanup() {
    if [ "$INTERACTIVE" = true ]; then
        tput cnorm 2>/dev/null || true
    fi
}
trap cleanup EXIT

# Skip setup if already completed
if [ -f ~/.setup-complete ]; then
    echo "âœ… Setup already completed on: $(cat ~/.setup-complete)"
    echo "   To re-run setup, delete ~/.setup-complete and restart container"
    exit 0
fi

echo "ðŸš€ Setting up Solidity development environment..."

# JetBrains uses /workspace as the mount point
WORKSPACE_DIR="/workspace"

echo "ðŸ“ Workspace: $WORKSPACE_DIR"

# Copy CLAUDE.md from mounted file (skip if already exists - migration case)
if [ -f "/tmp/claude-workflow.md" ]; then
    if [ -f "$WORKSPACE_DIR/CLAUDE.md" ]; then
        echo "ðŸ“„ CLAUDE.md already exists - skipping (migration case)"
    else
        echo "ðŸ“„ Copying CLAUDE.md..."
        cp /tmp/claude-workflow.md "$WORKSPACE_DIR/CLAUDE.md"
        echo "âœ… CLAUDE.md copied to project root"
    fi
    fi

# Git configuration
if [ -n "${GIT_AUTHOR_NAME}" ] && [ -n "${GIT_AUTHOR_EMAIL}" ]; then
    echo "ðŸ“ Configuring Git..."
    (
        git config --global user.name "${GIT_AUTHOR_NAME}"
        git config --global user.email "${GIT_AUTHOR_EMAIL}"
        git config --global init.defaultBranch main
        git config --global pull.rebase false
    ) &
    show_spinner $! "Configuring Git..."
    echo "âœ… Git configured"
fi

# Add .devcontainer/jetbrains_errors.log to .gitignore
if [ -f "$WORKSPACE_DIR/.gitignore" ]; then
    if ! grep -q "\.devcontainer/jetbrains_errors\.log" "$WORKSPACE_DIR/.gitignore"; then
        echo "" >> "$WORKSPACE_DIR/.gitignore"
        echo "# JetBrains IDE error logs (generated by dc nc --export)" >> "$WORKSPACE_DIR/.gitignore"
        echo ".devcontainer/jetbrains_errors.log" >> "$WORKSPACE_DIR/.gitignore"
        echo "âœ… Added jetbrains_errors.log to .gitignore"
    fi
else
    # Create .gitignore if it doesn't exist
    cat > "$WORKSPACE_DIR/.gitignore" << 'EOF'
# JetBrains IDE error logs (generated by dc nc --export)
.devcontainer/jetbrains_errors.log
EOF
    echo "âœ… Created .gitignore with jetbrains_errors.log"
fi

# Node/Yarn setup
if command -v node &> /dev/null; then
    echo "ðŸ“¦ Setting up Yarn..."

    (
        # Create minimal package.json if it doesn't exist to pin Yarn version
        # Users can modify or replace this file as needed
        if [ ! -f "$WORKSPACE_DIR/package.json" ]; then
            cat > "$WORKSPACE_DIR/package.json" <<'EOF'
{
  "packageManager": "yarn@4.12.0"
}
EOF
        fi

        # Pre-download Yarn to cache it (avoids download prompts)
        corepack prepare yarn@4.12.0 --activate &>/dev/null

        # Configure Yarn to use node-modules instead of PnP
        cat > "$WORKSPACE_DIR/.yarnrc.yml" <<EOF
nodeLinker: node-modules
EOF
    ) &
    show_spinner $! "Setting up Yarn..."
    echo "âœ… Yarn configured"
    echo "   - Node: $(node --version)"
    echo "   - Yarn: $(yarn --version)"
fi


# Prettier installation
if command -v yarn &> /dev/null && [ -f "$WORKSPACE_DIR/package.json" ]; then
    echo "ðŸŽ¨ Installing Prettier..."
    (
        cd "$WORKSPACE_DIR"
        yarn add -D prettier prettier-plugin-solidity &>/dev/null
    ) &
    show_spinner $! "Installing Prettier and prettier-plugin-solidity..."
    echo "âœ… Prettier installed"
fi

# Install Foundry (always for Solidity)
echo "ðŸ”¨ Installing Foundry..."
(
    curl -L https://foundry.paradigm.xyz | bash &>/dev/null
    export PATH="$HOME/.foundry/bin:$PATH"
    echo 'export PATH="$HOME/.foundry/bin:$PATH"' >> ~/.bashrc
    echo 'export PATH="$HOME/.foundry/bin:$PATH"' >> ~/.zshrc
    source ~/.bashrc || true
    foundryup
) &
show_spinner $! "Installing Foundry toolchain..."
echo "âœ… Foundry installed"

# Claude Code installation
echo "ðŸ¤– Installing Claude Code..."
if curl -fsSL https://claude.ai/install.sh | bash > /tmp/claude-install.log 2>&1; then
    echo "âœ… Claude Code installed"
else
    echo "âš ï¸  Claude Code installation failed (see /tmp/claude-install.log for details)"
    echo "   You can retry manually: curl -fsSL https://claude.ai/install.sh | bash"
fi

# Add Claude Code to PATH
echo 'export PATH="$HOME/.local/bin:$PATH"' >> ~/.bashrc
echo 'export PATH="$HOME/.local/bin:$PATH"' >> ~/.zshrc

# Load Anthropic credentials from mounted config file
if [ -z "${ANTHROPIC_BASE_URL}" ] || [ -z "${ANTHROPIC_AUTH_TOKEN}" ]; then
    if [ -f "/tmp/anthropic-cred.sh" ]; then
        source /tmp/anthropic-cred.sh
    fi
fi

# Write credentials to shell configs
if [ -n "${ANTHROPIC_BASE_URL}" ]; then
    echo "export ANTHROPIC_BASE_URL=\"${ANTHROPIC_BASE_URL}\"" >> ~/.bashrc
    echo "export ANTHROPIC_BASE_URL=\"${ANTHROPIC_BASE_URL}\"" >> ~/.zshrc
fi

if [ -n "${ANTHROPIC_AUTH_TOKEN}" ]; then
    echo "export ANTHROPIC_AUTH_TOKEN=\"${ANTHROPIC_AUTH_TOKEN}\"" >> ~/.bashrc
    echo "export ANTHROPIC_AUTH_TOKEN=\"${ANTHROPIC_AUTH_TOKEN}\"" >> ~/.zshrc
fi

export PATH="$HOME/.local/bin:$PATH"

# Configure Claude Code settings
if [ -n "${ANTHROPIC_AUTH_TOKEN}" ] && [ -n "${ANTHROPIC_BASE_URL}" ]; then
    echo "âš™ï¸  Configuring Claude Code..."
    mkdir -p ~/.claude
    cat > ~/.claude/settings.json <<EOF
{
  "env": {
    "ANTHROPIC_AUTH_TOKEN": "${ANTHROPIC_AUTH_TOKEN}",
    "ANTHROPIC_BASE_URL": "${ANTHROPIC_BASE_URL}",
    "CLAUDE_CODE_DISABLE_NONESSENTIAL_TRAFFIC": 1
  }
}
EOF
    echo "âœ… Claude Code configured"
fi

# Codex installation
echo "ðŸ¤– Installing Codex..."
if sudo npm install -g @openai/codex > /tmp/codex-install.log 2>&1; then
    echo "âœ… Codex installed"
else
    echo "âš ï¸  Codex installation failed (see /tmp/codex-install.log for details)"
    echo "   You can retry manually: sudo npm install -g @openai/codex"
fi

# Copy Codex configuration files
echo "âš™ï¸  Configuring Codex..."
mkdir -p ~/.codex

if [ -f "/tmp/codex-agents.md" ]; then
    cp /tmp/codex-agents.md ~/.codex/AGENTS.md
    echo "âœ… Codex AGENTS.md copied"
fi

if [ -f "/tmp/codex-auth.json" ]; then
    cp /tmp/codex-auth.json ~/.codex/auth.json
    chmod 600 ~/.codex/auth.json  # Protect auth file
    echo "âœ… Codex auth.json copied"
fi

if [ -f "/tmp/codex-config.toml" ]; then
    cp /tmp/codex-config.toml ~/.codex/config.toml
    echo "âœ… Codex config.toml copied"
fi

# SSH server configuration
echo "ðŸ” Configuring SSH server..."
(
    # Create SSH directory
    mkdir -p ~/.ssh

    # Copy authorized_keys from mounted file
    if [ -f "/tmp/ssh-authorized-keys" ]; then
        cp /tmp/ssh-authorized-keys ~/.ssh/authorized_keys
    fi

    # Create SSH config for GitHub (port 443 for firewall compatibility)
    cat > ~/.ssh/config <<'EOF'
# ========================================
# GitHub (Custom Port)
# ========================================
Host github.com
    Hostname ssh.github.com
    Port 443
    User git
EOF

    # Set correct permissions AFTER all file operations
    chmod 700 ~/.ssh
    chmod 600 ~/.ssh/config
    chmod 600 ~/.ssh/authorized_keys 2>/dev/null || true

) &>/dev/null
echo "âœ… SSH keys configured"

# Start SSH service
if ps -p 1 -o comm= | grep -q systemd; then
    # systemd is PID 1 (actually running)
    sudo systemctl enable ssh >/dev/null 2>&1 || true
    sudo systemctl start ssh >/dev/null 2>&1 || true
    echo "âœ… SSH service started (systemd)"
else
    # Fallback for non-systemd containers (sysvinit)
    sudo update-rc.d ssh defaults >/dev/null 2>&1 || true
    sudo update-rc.d ssh enable >/dev/null 2>&1 || true
    sudo service ssh start >/dev/null 2>&1 || sudo /usr/sbin/sshd >/dev/null 2>&1 || true
    echo "âœ… SSH service started (service)"
fi

# âš ï¸  WARP SHELL INTEGRATION WARNING âš ï¸
# The following Warp terminal integration hooks are based on Warp's official documentation
# as of 2025-12. These commands may change in future Warp versions.
# Official source: https://docs.warp.dev/features/subshells-and-shells
#
# If Warp terminal fails to detect shell integration in the future, check:
# 1. Warp's latest documentation for updated integration commands
# 2. Remove outdated hooks and replace with new ones
# 3. File location: templates/web3/solidity/.devcontainer/setup.sh

echo "ðŸš€ Configuring Warp shell integration..."

# Add Warp integration hook to bash shell
cat >> ~/.bashrc <<'EOF'

# Warp terminal shell integration (added by dc devcontainer template)
# Warning: This may need updating in future Warp versions
printf '\eP$f{"hook": "SourcedRcFileForWarp", "value": { "shell": "bash"}}\x9c'
EOF
echo "âœ… Warp integration added to ~/.bashrc"

# Add Warp integration hook to zsh shell
cat >> ~/.zshrc <<'EOF'

# Warp terminal shell integration (added by dc devcontainer template)
# Warning: This may need updating in future Warp versions
printf '\eP$f{"hook": "SourcedRcFileForWarp", "value": { "shell": "zsh"}}\x9c'
EOF
echo "âœ… Warp integration added to ~/.zshrc"

# Summary
echo ""
echo "âœ… Solidity environment setup complete!"
echo ""
echo "ðŸ“Œ Environment:"
[ -n "$(command -v node)" ] && echo "   - Node: $(node --version)"
[ -n "$(command -v yarn)" ] && echo "   - Yarn: $(yarn --version)"
[ -n "$(command -v forge)" ] && echo "   - Foundry: $(forge --version | head -1)"
[ -n "$(command -v codex)" ] && echo "   - Codex: $(codex --version)"
[ -n "$(command -v claude)" ] && echo "   - Claude Code: $(claude --version)"
[ -n "${GIT_AUTHOR_NAME}" ] && echo "   - Git: ${GIT_AUTHOR_NAME} <${GIT_AUTHOR_EMAIL}>"
echo ""

# Mark setup as complete
touch ~/.setup-complete
echo "$(date)" > ~/.setup-complete

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multi-Chain Asset Rebalancing & Arbitrage Solution</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #7c3aed;
            --secondary: #10b981;
            --dark: #0f172a;
            --card-bg: #1e293b;
            --border: #334155;
        }
        
        body {
            background: linear-gradient(135deg, #0f172a, #1e293b);
            color: #e2e8f0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            min-height: 100vh;
        }
        
        .glass-card {
            background: rgba(30, 41, 59, 0.8);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
        }
        
        .nav-tabs {
            border-bottom: 1px solid var(--border);
        }
        
        .nav-tabs .nav-link {
            color: #94a3b8;
            border: none;
            padding: 12px 24px;
        }
        
        .nav-tabs .nav-link.active {
            color: #60a5fa;
            background: transparent;
            border-bottom: 2px solid #60a5fa;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--primary), #8b5cf6);
            border: none;
            border-radius: 10px;
            padding: 10px 20px;
            transition: all 0.3s;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(124, 58, 237, 0.4);
        }
        
        .btn-success {
            background: linear-gradient(135deg, #10b981, #34d399);
            border: none;
            border-radius: 10px;
            padding: 10px 20px;
            transition: all 0.3s;
        }
        
        .btn-warning {
            background: linear-gradient(135deg, #f59e0b, #fbbf24);
            border: none;
            border-radius: 10px;
            padding: 10px 20px;
            transition: all 0.3s;
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #ef4444, #f87171);
            border: none;
            border-radius: 10px;
            padding: 10px 20px;
            transition: all 0.3s;
        }
        
        .btn-outline-light {
            border: 1px solid var(--border);
            border-radius: 10px;
        }
        
        .nft-card {
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
            transition: all 0.3s;
            height: 100%;
        }
        
        .nft-card:hover {
            transform: translateY(-5px);
            border-color: var(--primary);
            box-shadow: 0 10px 25px rgba(124, 58, 237, 0.2);
        }
        
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(96, 165, 250, 0.3);
            border-radius: 50%;
            border-top-color: #60a5fa;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .modal-content {
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 16px;
        }
        
        .form-control {
            background: rgba(15, 23, 42, 0.8);
            border: 1px solid var(--border);
            color: white;
        }
        
        .form-control:focus {
            background: rgba(15, 23, 42, 0.9);
            border-color: var(--primary);
            color: white;
            box-shadow: 0 0 0 0.25rem rgba(124, 58, 237, 0.25);
        }
        
        .table-dark {
            background: rgba(15, 23, 42, 0.8);
            border-radius: 12px;
            overflow: hidden;
        }
        
        .strategy-item {
            background: rgba(15, 23, 42, 0.5);
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 10px;
            border-left: 4px solid var(--primary);
        }
        
        .percentage-slider {
            width: 100%;
            margin: 10px 0;
            -webkit-appearance: none;
            height: 8px;
            border-radius: 4px;
            background: rgba(255, 255, 255, 0.1);
            outline: none;
        }
        
        .percentage-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--primary);
            cursor: pointer;
        }
        
        .percentage-slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--primary);
            cursor: pointer;
            border: none;
        }
        
        .ai-suggestion {
            background: rgba(59, 130, 246, 0.1);
            border: 1px dashed rgba(59, 130, 246, 0.5);
            border-radius: 10px;
            padding: 15px;
            margin: 10px 0;
        }
        
        .ai-suggestion:hover {
            background: rgba(59, 130, 246, 0.2);
            cursor: pointer;
        }
        
        .ai-response {
            white-space: pre-wrap;
            background: rgba(0, 0, 0, 0.2);
            padding: 10px;
            border-radius: 8px;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .balance-actions {
            display: flex;
            gap: 5px;
        }
        
        .balance-actions button {
            flex: 1;
            padding: 5px 10px;
            font-size: 0.8rem;
        }
        
        .auto-adjust-container {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .auto-adjust-container input {
            flex: 1;
        }
        
        .nft-market-item {
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 15px;
            transition: all 0.3s;
        }
        
        .nft-market-item:hover {
            transform: translateY(-3px);
            border-color: var(--primary);
            box-shadow: 0 8px 20px rgba(124, 58, 237, 0.2);
        }
        
        .nft-id {
            background: rgba(124, 58, 237, 0.2);
            color: #c4b5fd;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.8rem;
        }
        
        .search-box {
            background: rgba(15, 23, 42, 0.8);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
        }
        
        .asset-badge {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 500;
        }
        
        .asset-badge.mon {
            background: rgba(38, 2, 102, 0.2);
            color: #f2f1f6;
        }
        
        .asset-badge.musd {
            background: rgba(1, 69, 46, 0.2);
            color: #eaefed;
        }
        
        .asset-badge.hsk {
            background: rgba(255, 107, 0, 0.2);
            color: #ffd8b5;
        }
        
        .asset-badge.hskusd {
            background: rgba(0, 100, 255, 0.2);
            color: #b5d0ff;
        }
        
        .asset-badge.dev {
            background: rgba(128, 0, 128, 0.2);
            color: #e6b3e6;
        }
        
        .asset-badge.sepeth {
            background: rgba(0, 128, 0, 0.2);
            color: #b3e6b3;
        }
        
        .chain-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: bold;
            margin-right: 5px;
        }
        
        .chain-badge.hashkey {
            background: linear-gradient(135deg, #ff6b00, #ff8c42);
            color: white;
        }
        
        .chain-badge.monad {
            background: linear-gradient(135deg, #7c3aed, #8b5cf6);
            color: white;
        }
        
        .chain-badge.moonbase {
            background: linear-gradient(135deg, #6b46c1, #9f7aea);
            color: white;
        }
        
        .chain-badge.sepolia {
            background: linear-gradient(135deg, #10b981, #34d399);
            color: white;
        }
        
        .stats-card {
            background: rgba(15, 23, 42, 0.5);
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 10px;
        }
        
        /* Improved slider styles */
        .form-range {
            height: 8px;
            border-radius: 4px;
            background: rgba(255, 255, 255, 0.1);
        }
        
        .form-range::-webkit-slider-thumb {
            background: var(--primary);
            border: 2px solid white;
            width: 20px;
            height: 20px;
        }
        
        .form-range::-moz-range-thumb {
            background: var(--primary);
            border: 2px solid white;
            width: 20px;
            height: 20px;
        }
        
        .percentage-control {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .percentage-control .slider-container {
            flex: 1;
        }
        
        .percentage-control .input-container {
            width: 100px;
        }
        
        .percentage-control label {
            width: 80px;
        }
        
        .modified-badge {
            font-size: 0.7rem;
            padding: 1px 5px;
            border-radius: 3px;
            background: rgba(245, 158, 11, 0.2);
            color: #fbbf24;
        }
        
        /* Groq AI specific styles */
        .groq-badge {
            background: linear-gradient(135deg, #00a86b, #00d084);
            color: white;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: bold;
        }
        
        .api-key-input {
            position: relative;
        }
        
        .api-key-input .toggle-visibility {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            background: transparent;
            border: none;
            color: #94a3b8;
            cursor: pointer;
        }
        
        /* Strategy execution buttons */
        .strategy-execution-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        .strategy-execution-buttons button {
            flex: 1;
        }
        
        /* Additional prompt styles */
        .additional-prompt {
            margin-top: 15px;
        }
        
        .additional-prompt textarea {
            min-height: 80px;
            resize: vertical;
        }
        
        /* Strategy action panel */
        .strategy-action-panel {
            background: rgba(15, 23, 42, 0.6);
            border-radius: 10px;
            padding: 15px;
            margin-top: 20px;
            border: 1px solid var(--border);
        }
        
        .strategy-action-panel h6 {
            color: #60a5fa;
        }
        
        /* NFT strategy actions */
        .nft-strategy-actions {
            display: flex;
            gap: 5px;
            margin-top: 10px;
        }
        
        .nft-strategy-actions button {
            flex: 1;
            padding: 5px 10px;
            font-size: 0.8rem;
        }
        
        /* Network selector */
        .network-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .network-selector .btn {
            flex: 1;
            min-width: 120px;
        }
        
        /* Asset chain grouping */
        .chain-group {
            margin-bottom: 25px;
            border: 1px solid var(--border);
            border-radius: 12px;
            overflow: hidden;
        }
        
        .chain-header {
            background: rgba(15, 23, 42, 0.9);
            padding: 12px 15px;
            border-bottom: 1px solid var(--border);
        }
        
        .chain-header h5 {
            margin: 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .asset-icon {
            width: 24px;
            height: 24px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .asset-icon.mon {
            background: rgba(124, 58, 237, 0.2);
            color: #c4b5fd;
        }
        
        .asset-icon.hsk {
            background: rgba(255, 107, 0, 0.2);
            color: #ffb380;
        }
        
        .asset-icon.dev {
            background: rgba(128, 0, 128, 0.2);
            color: #d9b3d9;
        }
        
        .asset-icon.sepeth {
            background: rgba(0, 128, 0, 0.2);
            color: #99cc99;
        }
        
        .asset-icon.hskusd {
            background: rgba(0, 100, 255, 0.2);
            color: #99b3ff;
        }
        
        .asset-icon.musd {
            background: rgba(1, 69, 46, 0.2);
            color: #99ffcc;
        }
        
        /* Asset type tabs */
        .asset-type-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .asset-type-tabs .btn {
            flex: 1;
        }
        
        /* All-chain allocation */
        .allocation-card {
            background: rgba(15, 23, 42, 0.7);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid var(--border);
        }
        
        .allocation-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .allocation-progress {
            height: 10px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 5px;
            overflow: hidden;
            margin: 10px 0;
        }
        
        .allocation-progress-bar {
            height: 100%;
            transition: width 0.3s;
        }
        
        .allocation-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            margin-bottom: 8px;
        }
        
        .allocation-item:last-child {
            margin-bottom: 0;
        }
        
        /* Fix for marketplace loading */
        .marketplace-loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 60px 20px;
        }
        
        .marketplace-loading .loading {
            width: 40px;
            height: 40px;
            margin-bottom: 20px;
        }
        
        /* NFT chain indicator */
        .nft-chain-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.7rem;
            font-weight: bold;
            margin-left: 8px;
        }
        
        /* Chain Asset Ratio Controls */
        .chain-ratio-controls {
            margin-top: 10px;
            padding: 10px;
            background: rgba(15, 23, 42, 0.5);
            border-radius: 8px;
        }
        
        .chain-ratio-controls h6 {
            color: #60a5fa;
            margin-bottom: 10px;
            font-size: 0.9rem;
        }
        
        .chain-ratio-inputs {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
        }
        
        .chain-ratio-inputs label {
            min-width: 80px;
            font-size: 0.85rem;
        }
        
        .chain-ratio-slider {
            flex: 1;
        }
        
        .chain-ratio-value {
            width: 60px;
        }
        
        .ratio-summary {
            font-size: 0.8rem;
            color: #94a3b8;
            margin-top: 5px;
            display: flex;
            justify-content: space-between;
        }
        
        /* Asset Adjustment Panel */
        .asset-adjustment-panel {
            background: rgba(15, 23, 42, 0.7);
            border-radius: 10px;
            padding: 15px;
            margin-top: 15px;
            border: 1px solid var(--border);
        }
        
        .asset-adjustment-panel h6 {
            color: #f59e0b;
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 15px;
        }
        
        /* Enhanced Trade Modal */
        .trade-modal-body {
            max-height: 70vh;
            overflow-y: auto;
        }
        
        .trade-section {
            background: rgba(15, 23, 42, 0.6);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }
        
        .trade-section h6 {
            color: #34d399;
            border-bottom: 1px solid var(--border);
            padding-bottom: 8px;
            margin-bottom: 12px;
        }
        
        .asset-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .asset-selector .form-select {
            flex: 1;
        }
        
        .amount-input {
            margin-bottom: 15px;
        }
        
        .amount-input label {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
        }
        
        .amount-input .balance {
            font-size: 0.8rem;
            color: #94a3b8;
        }
        
        .trade-preview {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            padding: 10px;
            margin-top: 15px;
        }
        
        .trade-preview-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 5px 0;
            border-bottom: 1px dashed var(--border);
        }
        
        .trade-preview-item:last-child {
            border-bottom: none;
        }
        
        .trade-preview-item .label {
            color: #94a3b8;
        }
        
        .trade-preview-item .value {
            font-weight: bold;
        }
        
        /* Chain-specific asset controls */
        .chain-asset-controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 15px;
        }
        
        .asset-control-group {
            background: rgba(15, 23, 42, 0.6);
            border-radius: 8px;
            padding: 12px;
            border: 1px solid var(--border);
        }
        
        .asset-control-group h6 {
            color: #c4b5fd;
            font-size: 0.9rem;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        /* Transaction status */
        .transaction-status {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
        }
        
        .transaction-step {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
        }
        
        .transaction-step i {
            width: 20px;
        }
        
        .transaction-step.completed {
            color: #10b981;
        }
        
        .transaction-step.pending {
            color: #f59e0b;
        }
        
        .transaction-step.failed {
            color: #ef4444;
        }
    </style>
</head>
<body>
    <!-- Navigation Bar -->
    <nav class="navbar navbar-dark glass-card">
        <div class="container">
            <span class="navbar-brand">
                <i class="fas fa-chart-network me-2"></i>
                <strong>Multi-Chain Asset Rebalancing & Arbitrage Solution</strong>
                <small class="text-warning ms-2">EVM Testnet</small>
            </span>
            <div id="walletInfo">
                <button class="btn btn-primary" onclick="connectWallet()">
                    <i class="fas fa-wallet me-2"></i>Connect Wallet
                </button>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- Network Selector -->
        <div class="network-selector">
            <button class="btn btn-outline-light active" onclick="setActiveChain('all')">
                <i class="fas fa-globe me-2"></i>All Chains
            </button>
            <button class="btn btn-outline-light" onclick="setActiveChain(133)">
                <i class="fas fa-fire me-2"></i>HashKey Chain
            </button>
            <button class="btn btn-outline-light" onclick="setActiveChain(10143)">
                <i class="fas fa-bolt me-2"></i>Monad Testnet
            </button>
            <button class="btn btn-outline-light" onclick="setActiveChain(1287)">
                <i class="fas fa-moon me-2"></i>Moonbase Alpha
            </button>
            <button class="btn btn-outline-light" onclick="setActiveChain(11155111)">
                <i class="fas fa-ethereum me-2"></i>Sepolia
            </button>
        </div>

        <!-- Tab Navigation -->
        <ul class="nav nav-tabs" id="mainTabs">
            <li class="nav-item">
                <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#dashboard">
                    <i class="fas fa-home me-2"></i>Dashboard
                </button>
            </li>
            <li class="nav-item">
                <button class="nav-link" data-bs-toggle="tab" data-bs-target="#portfolio">
                    <i class="fas fa-chart-pie me-2"></i>Asset Management
                </button>
            </li>
            <li class="nav-item">
                <button class="nav-link" data-bs-toggle="tab" data-bs-target="#strategyBuilder">
                    <i class="fas fa-robot me-2"></i>LLM Strategy Builder
                </button>
            </li>
            <li class="nav-item">
                <button class="nav-link" data-bs-toggle="tab" data-bs-target="#nftMarket">
                    <i class="fas fa-store me-2"></i>Strategy Marketplace
                </button>
            </li>
            <li class="nav-item">
                <button class="nav-link" data-bs-toggle="tab" data-bs-target="#dex">
                    <i class="fas fa-exchange-alt me-2"></i>DEX Swap
                </button>
            </li>
        </ul>

        <!-- Tab Content -->
        <div class="tab-content mt-4">
            <!-- Dashboard -->
            <div class="tab-pane fade show active" id="dashboard">
                <div class="row">
                    <div class="col-lg-8">
                        <div class="glass-card p-4 mb-4">
                            <h4><i class="fas fa-rocket me-2"></i>Quick Start</h4>
                            <div class="row mt-4">
                                <div class="col-md-4 mb-3">
                                    <div class="nft-card text-center">
                                        <i class="fas fa-coins fa-3x mb-3" style="color: #7c3aed;"></i>
                                        <h5>Multi-Chain Assets</h5>
                                        <p class="text-muted small">View and manage assets across all chains</p>
                                        <button class="btn btn-primary w-100" onclick="switchTab('portfolio')">
                                            Go to Asset Management
                                        </button>
                                    </div>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <div class="nft-card text-center">
                                        <i class="fas fa-robot fa-3x mb-3" style="color: #10b981;"></i>
                                        <h5>AI Strategy Builder</h5>
                                        <p class="text-muted small">Create cross-chain investment strategies</p>
                                        <button class="btn btn-primary w-100" onclick="switchTab('strategyBuilder')">
                                            Go to LLM Strategy Builder
                                        </button>
                                    </div>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <div class="nft-card text-center">
                                        <i class="fas fa-store fa-3x mb-3" style="color: #f59e0b;"></i>
                                        <h5>Multi-Chain NFTs</h5>
                                        <p class="text-muted small">Browse strategy NFTs from all chains</p>
                                        <button class="btn btn-primary w-100" onclick="switchTab('nftMarket')">
                                            Go to Strategy Marketplace
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Cross-Chain Portfolio Overview -->
                        <div class="glass-card p-4 mb-4">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h4><i class="fas fa-globe-americas me-2"></i>Cross-Chain Portfolio Overview</h4>
                                <button class="btn btn-sm btn-primary" onclick="loadMultiChainAssets()">
                                    <i class="fas fa-sync-alt me-1"></i>Refresh
                                </button>
                            </div>
                            <div id="crossChainOverview">
                                <div class="alert alert-info">
                                    <span class="loading me-2"></span> Loading cross-chain portfolio data...
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-lg-4">
                        <div class="glass-card p-4">
                            <h5><i class="fas fa-info-circle me-2"></i>System Status</h5>
                            <div id="systemStatus" class="mt-3">
                                <div class="alert alert-dark">
                                    <i class="fas fa-sync-alt loading me-2"></i>
                                    Checking system status...
                                </div>
                            </div>
                            
                            <div class="mt-4">
                                <h6>Supported Chains</h6>
                                <div class="small">
                                    <p class="mb-1">
                                        <span class="chain-badge hashkey">HashKey</span>
                                        Chain ID: 133 (HSK/hskUSD)
                                    </p>
                                    <p class="mb-1">
                                        <span class="chain-badge monad">Monad</span>
                                        Chain ID: 10143 (MON/mUSD)
                                    </p>
                                    <p class="mb-1">
                                        <span class="chain-badge moonbase">Moonbase</span>
                                        Chain ID: 1287 (DEV)
                                    </p>
                                    <p class="mb-1">
                                        <span class="chain-badge sepolia">Sepolia</span>
                                        Chain ID: 11155111 (SepoliaETH)
                                    </p>
                                </div>
                            </div>
                            
                            <div class="mt-4">
                                <h6>Quick Actions</h6>
                                <div class="d-grid gap-2 mt-3">
                                    <button class="btn btn-sm btn-outline-primary" onclick="showAllChainRebalance()">
                                        <i class="fas fa-balance-scale me-1"></i>Cross-Chain Rebalance
                                    </button>
                                    <button class="btn btn-sm btn-outline-success" onclick="generateCrossChainAIStrategy()">
                                        <i class="fas fa-robot me-1"></i>Generate Cross-Chain Strategy
                                    </button>
                                    <div class="d-flex gap-2 mt-2">
                                        <a href="https://testnet.hsk.xyz/" target="_blank" class="btn btn-sm btn-warning flex-fill">
                                            <i class="fas fa-faucet me-1"></i>HashKey Faucet
                                        </a>
                                        <a href="https://testnet.monad.xyz/" target="_blank" class="btn btn-sm btn-outline-info flex-fill">
                                            <i class="fas fa-faucet me-1"></i>Monad Faucet
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Asset Management -->
            <div class="tab-pane fade" id="portfolio">
                <div class="row">
                    <div class="col-lg-8">
                        <!-- Asset Type Tabs -->
                        <div class="asset-type-tabs">
                            <button class="btn btn-outline-light active" onclick="showAssetType('all')">
                                <i class="fas fa-globe me-2"></i>All Assets
                            </button>
                            <button class="btn btn-outline-light" onclick="showAssetType('native')">
                                <i class="fas fa-coins me-2"></i>Native Tokens
                            </button>
                            <button class="btn btn-outline-light" onclick="showAssetType('stable')">
                                <i class="fas fa-dollar-sign me-2"></i>Stablecoins
                            </button>
                        </div>
                        
                        <!-- Multi-Chain Assets -->
                        <div class="glass-card p-4 mb-4">
                            <div class="d-flex justify-content-between align-items-center mb-4">
                                <h4><i class="fas fa-coins me-2"></i>Multi-Chain Assets</h4>
                                <div>
                                    <button class="btn btn-success me-2" onclick="showCrossChainRebalanceModal()">
                                        <i class="fas fa-balance-scale me-2"></i>Cross-Chain Rebalance
                                    </button>
                                    <button class="btn btn-primary" onclick="loadMultiChainAssets()">
                                        <i class="fas fa-sync-alt me-2"></i>Refresh
                                    </button>
                                </div>
                            </div>
                            
                            <div id="multiChainAssetsContainer">
                                <div class="alert alert-info">
                                    <i class="fas fa-info-circle me-2"></i>
                                    Connect your wallet to view multi-chain assets
                                </div>
                            </div>
                        </div>
                        
                        <!-- Chain Asset Ratio Controls -->
                        <div class="glass-card p-4 mb-4" id="chainRatioControls" style="display: none;">
                            <h4><i class="fas fa-sliders-h me-2"></i>Chain Asset Ratio Adjustment</h4>
                            <div id="chainRatioControlsContent" class="mt-3">
                                <!-- Chain-specific ratio controls will be loaded here -->
                            </div>
                            <div class="mt-3">
                                <button class="btn btn-primary" onclick="applyChainAssetRatios()">
                                    <i class="fas fa-check me-2"></i>Apply Chain Ratios
                                </button>
                                <button class="btn btn-outline-secondary ms-2" onclick="resetChainAssetRatios()">
                                    <i class="fas fa-redo me-2"></i>Reset to Default
                                </button>
                            </div>
                        </div>
                        
                        <!-- Cross-Chain Allocation -->
                        <div class="allocation-card">
                            <div class="allocation-header">
                                <h5><i class="fas fa-chart-pie me-2"></i>Cross-Chain Allocation</h5>
                                <div>
                                    <button class="btn btn-sm btn-outline-primary" onclick="autoBalanceCrossChain()">
                                        <i class="fas fa-magic me-1"></i>Auto Balance
                                    </button>
                                    <button class="btn btn-sm btn-outline-secondary ms-2" onclick="resetCrossChainAllocation()">
                                        <i class="fas fa-redo me-1"></i>Reset
                                    </button>
                                </div>
                            </div>
                            
                            <div id="crossChainAllocation">
                                <div class="alert alert-dark">
                                    <span class="loading me-2"></span> Calculating cross-chain allocation...
                                </div>
                            </div>
                            
                            <div class="mt-4">
                                <div class="d-grid gap-2">
                                    <button class="btn btn-primary" onclick="applyCrossChainAllocation()">
                                        <i class="fas fa-check me-2"></i>Apply Cross-Chain Allocation
                                    </button>
                                    <button class="btn btn-success" onclick="executeCrossChainRebalance()">
                                        <i class="fas fa-play me-2"></i>Execute Cross-Chain Rebalance
                                    </button>
                                </div>
                                <div id="crossChainResult" class="mt-3"></div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-lg-4">
                        <!-- Portfolio Summary -->
                        <div class="glass-card p-4 mb-4">
                            <h5><i class="fas fa-chart-bar me-2"></i>Portfolio Summary</h5>
                            <div id="portfolioSummary" class="mt-3">
                                <div class="stats-card">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <span>Total Value</span>
                                        <span class="fw-bold" id="totalPortfolioValue">0.00</span>
                                    </div>
                                </div>
                                <div class="stats-card">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <span>Number of Chains</span>
                                        <span class="fw-bold" id="chainCount">0</span>
                                    </div>
                                </div>
                                <div class="stats-card">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <span>Number of Assets</span>
                                        <span class="fw-bold" id="assetCount">0</span>
                                    </div>
                                </div>
                                <div class="stats-card">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <span>Average per Chain</span>
                                        <span class="fw-bold" id="avgPerChain">0.00</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Asset Distribution -->
                        <div class="glass-card p-4 mb-4">
                            <h5><i class="fas fa-chart-pie me-2"></i>Asset Distribution</h5>
                            <div id="assetDistributionChart" class="mt-3">
                                <div class="text-center py-4">
                                    <span class="loading"></span>
                                    <p class="small text-muted mt-2">Loading distribution data...</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Quick Actions -->
                        <div class="glass-card p-4">
                            <h5><i class="fas fa-bolt me-2"></i>Quick Actions</h5>
                            <div class="d-grid gap-2 mt-3">
                                <button class="btn btn-outline-primary" onclick="optimizeCrossChainAllocation()">
                                    <i class="fas fa-brain me-2"></i>Optimize Allocation
                                </button>
                                <button class="btn btn-outline-success" onclick="generateQuickStrategy()">
                                    <i class="fas fa-robot me-2"></i>Quick AI Strategy
                                </button>
                                <button class="btn btn-outline-warning" onclick="showTradeAllModal()">
                                    <i class="fas fa-exchange-alt me-2"></i>Cross-Chain Trade
                                </button>
                                <button class="btn btn-outline-info" onclick="toggleChainRatioControls()">
                                    <i class="fas fa-percentage me-2"></i>Chain Ratios
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- LLM Strategy Builder -->
            <div class="tab-pane fade" id="strategyBuilder">
                <div class="row">
                    <div class="col-lg-5">
                        <div class="glass-card p-4 mb-4">
                            <h4><i class="fas fa-chart-pie me-2"></i>Cross-Chain Holdings</h4>
                            
                            <div class="mt-3" id="crossChainHoldings">
                                <div class="alert alert-info">
                                    <span class="loading"></span> Loading cross-chain holdings...
                                </div>
                            </div>
                            
                            <div class="mt-4">
                                <h5><i class="fas fa-sliders-h me-2"></i>Cross-Chain Strategy Configuration</h5>
                                
                                <div id="crossChainStrategyConfig" class="mt-3">
                                    <div class="mb-3">
                                        <label class="form-label">Strategy Name</label>
                                        <input type="text" class="form-control" id="crossChainStrategyName" 
                                               placeholder="e.g., Cross-Chain Balanced Portfolio">
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label class="form-label">Strategy Type</label>
                                        <select class="form-control" id="strategyType">
                                            <option value="cross_chain">Cross-Chain Allocation</option>
                                            <option value="asset_type">By Asset Type</option>
                                            <option value="risk_based">Risk-Based Allocation</option>
                                            <option value="chain_specific">Chain-Specific Configuration</option>
                                            <option value="manual">Manual Configuration</option>
                                        </select>
                                    </div>
                                    
                                    <div id="crossChainAllocationConfig">
                                        <!-- Cross-chain allocation configuration will be dynamically generated -->
                                        <div class="alert alert-info">
                                            <i class="fas fa-info-circle me-2"></i>
                                            Select strategy type to configure allocation
                                        </div>
                                    </div>
                                    
                                    <div class="strategy-execution-buttons">
                                        <button class="btn btn-primary" onclick="mintCrossChainStrategyNFT()">
                                            <i class="fas fa-mint me-2"></i>Mint Strategy NFT
                                        </button>
                                        <button class="btn btn-success" onclick="executeCrossChainStrategy()">
                                            <i class="fas fa-play me-2"></i>Execute Strategy
                                        </button>
                                    </div>
                                    
                                    <div id="crossChainMintStatus" class="mt-3 text-center"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-lg-7">
                        <div class="glass-card p-4 h-100">
                            <div class="d-flex justify-content-between align-items-center mb-4">
                                <h4><i class="fas fa-robot me-2"></i>AI Cross-Chain Strategy Generator</h4>
                                <span class="groq-badge">Powered by Groq</span>
                            </div>
                            
                            <div class="mt-4">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3 api-key-input">
                                            <label class="form-label">Groq API Key</label>
                                            <input type="password" class="form-control" id="groqApiKey" 
                                                   placeholder="Enter your Groq API key"
                                                   value="">
                                            <button type="button" class="toggle-visibility" onclick="toggleApiKeyVisibility()">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                            <small class="text-muted">Get your key from <a href="https://console.groq.com/keys" target="_blank" class="text-info">Groq Console</a></small>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label">Groq Model</label>
                                            <select class="form-control" id="groqModel">
                                                <option value="llama-3.1-8b-instant">Llama 3.1 8B Instant</option>
                                                <option value="llama-3.3-70b-versatile">Llama 3.3 70B Versatile</option>
                                                <option value="mixtral-8x7b-32768">Mixtral 8x7b</option>
                                                <option value="gemma2-9b-it">Gemma2 9B</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label">Investment Goal</label>
                                            <select class="form-control" id="investmentGoal">
                                                <option value="balanced">Balanced</option>
                                                <option value="growth">Growth</option>
                                                <option value="conservative">Conservative</option>
                                                <option value="aggressive">Aggressive</option>
                                                <option value="cross_chain_arbitrage">Cross-Chain Arbitrage</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label">Risk Tolerance</label>
                                            <select class="form-control" id="riskTolerance">
                                                <option value="low">Low Risk</option>
                                                <option value="medium" selected>Medium Risk</option>
                                                <option value="high">High Risk</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label">Time Horizon</label>
                                            <select class="form-control" id="timeHorizon">
                                                <option value="short">Short-term (1-3 months)</option>
                                                <option value="medium" selected>Medium-term (3-12 months)</option>
                                                <option value="long">Long-term (1+ years)</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label">Focus Area</label>
                                            <select class="form-control" id="focusArea">
                                                <option value="all_chains">All Chains</option>
                                                <option value="defi_chains">DeFi Chains</option>
                                                <option value="stablecoins">Stablecoins</option>
                                                <option value="native_tokens">Native Tokens</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Additional user input for AI prompts -->
                                <div class="mb-3 additional-prompt">
                                    <label class="form-label">
                                        <i class="fas fa-comment-dots me-2"></i>Additional Context (Optional)
                                    </label>
                                    <textarea class="form-control" id="additionalPrompt" 
                                              placeholder="Provide additional context for AI strategy generation, e.g., market outlook, specific requirements, etc." 
                                              rows="3"></textarea>
                                </div>
                                
                                <div class="d-grid gap-2">
                                    <button class="btn btn-primary py-3" onclick="generateCrossChainAIStrategy()">
                                        <i class="fas fa-magic me-2"></i>Generate Cross-Chain AI Strategy
                                    </button>
                                    <button class="btn btn-outline-primary" onclick="applyCrossChainAISuggestion()">
                                        <i class="fas fa-check-circle me-2"></i>Apply AI Suggestion
                                    </button>
                                </div>
                                
                                <div id="crossChainAIResults" class="mt-4">
                                    <div class="alert alert-dark">
                                        <i class="fas fa-robot me-2"></i>
                                        Configure AI parameters and click the button above to generate cross-chain strategy suggestions
                                    </div>
                                </div>
                                
                                <!-- Strategy Action Panel -->
                                <div class="strategy-action-panel" id="crossChainStrategyActionPanel" style="display: none;">
                                    <h6><i class="fas fa-cogs me-2"></i>Strategy Actions</h6>
                                    <p class="small text-muted mb-3">Execute the current cross-chain strategy configuration on your portfolio</p>
                                    <div class="strategy-execution-buttons">
                                        <button class="btn btn-success" onclick="executeCrossChainStrategy()">
                                            <i class="fas fa-play me-2"></i>Execute Strategy
                                        </button>
                                        <button class="btn btn-primary" onclick="mintCrossChainStrategyNFT()">
                                            <i class="fas fa-mint me-2"></i>Mint as NFT
                                        </button>
                                    </div>
                                </div>
                                
                                <div id="crossChainAISuggestions" class="mt-4">
                                    <!-- AI-generated cross-chain strategy suggestions will appear here -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Strategy Marketplace -->
            <div class="tab-pane fade" id="nftMarket">
                <div class="row">
                    <div class="col-lg-12">
                        <div class="glass-card p-4">
                            <div class="d-flex justify-content-between align-items-center mb-4">
                                <h4><i class="fas fa-store me-2"></i>Multi-Chain Strategy Marketplace</h4>
                                <div>
                                    <button class="btn btn-outline-light me-2" onclick="loadAllChainNFTs()">
                                        <i class="fas fa-sync-alt me-2"></i>Refresh Marketplace
                                    </button>
                                    <button class="btn btn-primary" onclick="mintCurrentCrossChainStrategy()">
                                        <i class="fas fa-mint me-2"></i>Mint Current Strategy
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Search Functionality -->
                            <div class="search-box">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label">Search NFT Strategies</label>
                                            <div class="input-group">
                                                <span class="input-group-text"><i class="fas fa-search"></i></span>
                                                <input type="text" class="form-control" id="nftSearchInput" 
                                                       placeholder="Enter strategy name, owner address, or Token ID...">
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="mb-3">
                                            <label class="form-label">Chain Filter</label>
                                            <select class="form-control" id="nftChainFilter">
                                                <option value="all">All Chains</option>
                                                <option value="133">HashKey Chain</option>
                                                <option value="10143">Monad Testnet</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="mb-3">
                                            <label class="form-label">Strategy Type</label>
                                            <select class="form-control" id="nftStrategyFilter">
                                                <option value="all">All Strategies</option>
                                                <option value="cross_chain">Cross-Chain</option>
                                                <option value="single_chain">Single Chain</option>
                                                <option value="ai_generated">AI Generated</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                                <div class="d-grid gap-2">
                                    <button class="btn btn-primary" onclick="searchAllChainNFTs()">
                                        <i class="fas fa-search me-2"></i>Search NFTs
                                    </button>
                                </div>
                            </div>
                            
                            <div class="alert alert-info mb-4">
                                <i class="fas fa-info-circle me-2"></i>
                                Displaying all on-chain NFT strategies from supported chains with search and filter functionality
                            </div>
                            
                            <!-- NFT Statistics -->
                            <div class="row mb-4" id="nftStatistics">
                                <div class="col-md-3">
                                    <div class="stats-card">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <span>Total NFTs</span>
                                            <span class="fw-bold" id="totalNFTCount">0</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="stats-card">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <span>HashKey Chain</span>
                                            <span class="fw-bold" id="hashkeyNFTCount">0</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="stats-card">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <span>Monad Testnet</span>
                                            <span class="fw-bold" id="monadNFTCount">0</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="stats-card">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <span>Cross-Chain</span>
                                            <span class="fw-bold" id="crossChainNFTCount">0</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div id="marketplace" class="row g-4">
                                <div class="marketplace-loading">
                                    <span class="loading"></span>
                                    <p class="text-muted">Loading multi-chain marketplace data...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- DEX Swap -->
            <div class="tab-pane fade" id="dex">
                <div class="row">
                    <div class="col-lg-8">
                        <div class="glass-card p-4 mb-4">
                            <h4><i class="fas fa-exchange-alt me-2"></i>Chain DEX Swap</h4>
                            <p class="text-muted mb-4">Trade assets within the same chain using the TinyDEX contract</p>
                            
                            <!-- Chain Selection -->
                            <div class="mb-4">
                                <label class="form-label">Select Chain</label>
                                <div class="row">
                                    <div class="col-md-3 mb-2">
                                        <button class="btn w-100 btn-outline-light" onclick="selectDexChain(133)">
                                            <i class="fas fa-fire me-2"></i>HashKey Chain
                                        </button>
                                    </div>
                                    <div class="col-md-3 mb-2">
                                        <button class="btn w-100 btn-outline-light" onclick="selectDexChain(10143)">
                                            <i class="fas fa-bolt me-2"></i>Monad Testnet
                                        </button>
                                    </div>
                                    <div class="col-md-3 mb-2">
                                        <button class="btn w-100 btn-outline-light" onclick="selectDexChain(1287)">
                                            <i class="fas fa-moon me-2"></i>Moonbase Alpha
                                        </button>
                                    </div>
                                    <div class="col-md-3 mb-2">
                                        <button class="btn w-100 btn-outline-light" onclick="selectDexChain(11155111)">
                                            <i class="fas fa-ethereum me-2"></i>Sepolia
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <div id="dexSwapContainer">
                                <div class="alert alert-info">
                                    <i class="fas fa-info-circle me-2"></i>
                                    Select a chain to start trading
                                </div>
                            </div>
                        </div>
                        
                        <!-- DEX Liquidity Info -->
                        <div class="glass-card p-4">
                            <h5><i class="fas fa-water me-2"></i>DEX Liquidity Information</h5>
                            <div id="dexLiquidityInfo" class="mt-3">
                                <div class="alert alert-dark">
                                    <span class="loading me-2"></span> Loading DEX liquidity data...
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-lg-4">
                        <!-- Quick Swap -->
                        <div class="glass-card p-4 mb-4">
                            <h5><i class="fas fa-bolt me-2"></i>Quick Swap</h5>
                            <div id="quickSwapForm" class="mt-3">
                                <div class="alert alert-info">
                                    <i class="fas fa-info-circle me-2"></i>
                                    Select a chain first
                                </div>
                            </div>
                        </div>
                        
                        <!-- Trade History -->
                        <div class="glass-card p-4">
                            <h5><i class="fas fa-history me-2"></i>Recent Trades</h5>
                            <div id="tradeHistory" class="mt-3">
                                <div class="text-center py-4">
                                    <i class="fas fa-exchange-alt fa-2x text-muted mb-3"></i>
                                    <p class="text-muted">No trade history yet</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Cross-Chain Rebalance Modal -->
    <div class="modal fade" id="crossChainRebalanceModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content glass-card">
                <div class="modal-header">
                    <h5 class="modal-title">Cross-Chain Rebalancing</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Rebalancing Strategy</label>
                        <select class="form-control" id="crossChainRebalanceStrategy">
                            <option value="balanced">Balanced Across Chains</option>
                            <option value="risk_based">Risk-Based Allocation</option>
                            <option value="performance">Performance-Based</option>
                            <option value="custom">Custom Allocation</option>
                        </select>
                    </div>
                    
                    <div id="crossChainCustomAllocation" class="mb-3" style="display: none;">
                        <label class="form-label">Custom Cross-Chain Allocation</label>
                        <div id="crossChainCustomAllocationInputs">
                            <!-- Custom allocation inputs will be dynamically generated -->
                        </div>
                    </div>
                    
                    <div id="crossChainRebalancePreview" class="mb-3">
                        <!-- Rebalance preview will be displayed here -->
                    </div>
                    
                    <div id="crossChainRebalanceStatus" class="mt-3 text-center"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="executeCrossChainRebalanceFromModal()">Execute Rebalance</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Chain Asset Trade Modal -->
    <div class="modal fade" id="chainTradeModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content glass-card">
                <div class="modal-header">
                    <h5 class="modal-title">Chain Asset Trading</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body trade-modal-body">
                    <div id="chainTradeContent">
                        <!-- Trade content will be loaded here -->
                    </div>
                    <div id="chainTradeStatus" class="mt-3 text-center"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- DEX Swap Modal -->
    <div class="modal fade" id="dexSwapModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content glass-card">
                <div class="modal-header">
                    <h5 class="modal-title">DEX Swap</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="dexSwapContent">
                        <!-- DEX swap content will be loaded here -->
                    </div>
                    <div id="dexSwapStatus" class="mt-3 text-center"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- All-Chain NFT Details Modal -->
    <div class="modal fade" id="nftDetailsModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content glass-card">
                <div class="modal-header">
                    <h5 class="modal-title">NFT Strategy Details</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="nftDetailsContent">
                        <!-- NFT details will be displayed here -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" onclick="useNFTFromDetails()">Use This Strategy</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
    
    <script>
        // ========== Multi-Chain Configuration ==========
        const CHAINS = {
            133: { // HashKey Chain
                name: "HashKey Chain",
                symbol: "HSK",
                rpcUrl: "https://testnet.hsk.xyz",
                explorer: "https://testnet.hsk.xyz",
                nativeToken: "HSK",
                stableToken: {
                    symbol: "hskUSD",
                    address: "0x1E04197BA40288c603f44E2e51d1E8cfc220f127",
                    decimals: 18
                },
                dex: "0xEB6e086CEf23725f82FcbA68Ca797eFd18b5b862",
                nft: "0x0e232f8Bd1fddd76aD9E8032Fb9BF4A506Adba59",
                factory: "0xd1B8857DE155A48A28C614a0dc466aC90E444fd0",
                router: "0x158aE3430c3B0BE6Fc64ed3dB8AAAd09E18223Ff",
                color: "#ff6b00"
            },
            10143: { // Monad Testnet
                name: "Monad Testnet",
                symbol: "MON",
                rpcUrl: "https://testnet-rpc.monad.xyz",
                explorer: "https://testnet.monad.xyz",
                nativeToken: "MON",
                stableToken: {
                    symbol: "mUSD",
                    address: "0x1E04197BA40288c603f44E2e51d1E8cfc220f127",
                    decimals: 18
                },
                dex: "0x0e232f8Bd1fddd76aD9E8032Fb9BF4A506Adba59",
                nft: "0x158aE3430c3B0BE6Fc64ed3dB8AAAd09E18223Ff",
                factory: "0xd1B8857DE155A48A28C614a0dc466aC90E444fd0",
                router: "0xD423cBec5535dD9f9bA422206b778aEe0e1246e7",
                color: "#7c3aed"
            },
            1287: { // Moonbase Alpha
                name: "Moonbase Alpha",
                symbol: "DEV",
                rpcUrl: "https://rpc.api.moonbase.moonbeam.network",
                explorer: "https://moonbase.moonscan.io",
                nativeToken: "DEV",
                stableToken: null,
                dex: null,
                nft: null,
                factory: null,
                router: null,
                color: "#6b46c1"
            },
            11155111: { // Sepolia
                name: "Sepolia",
                symbol: "SepoliaETH",
                rpcUrl: "https://sepolia.infura.io/v3/",
                explorer: "https://sepolia.etherscan.io",
                nativeToken: "SepoliaETH",
                stableToken: null,
                dex: null,
                nft: null,
                factory: null,
                router: null,
                color: "#10b981"
            }
        };

        // ========== Global State ==========
        let provider = null;
        let signer = null;
        let userAddress = null;
        let currentChainId = null;
        let activeChainFilter = 'all';
        let activeAssetType = 'all';
        let selectedDexChain = null;
        
        let allChainAssets = [];
        let allChainNFTs = [];
        let crossChainAllocation = {};
        let crossChainAIStrategy = null;
        
        // Chain-specific asset ratios
        let chainAssetRatios = {
            133: { native: 60, stable: 40 }, // HashKey: HSK 60%, hskUSD 40%
            10143: { native: 50, stable: 50 }, // Monad: MON 50%, mUSD 50%
            1287: { native: 100, stable: 0 }, // Moonbase: DEV 100%
            11155111: { native: 100, stable: 0 } // Sepolia: ETH 100%
        };

        // Contract ABIs
        const TOKEN_ABI = [
            "function balanceOf(address) view returns (uint256)",
            "function transfer(address,uint256) returns (bool)",
            "function approve(address,uint256) returns (bool)",
            "function decimals() view returns (uint8)",
            "function transferFrom(address,address,uint256) returns (bool)",
            "function symbol() view returns (string)",
            "function name() view returns (string)"
        ];
        
        // TinyDEX ABI
        const TINYDEX_ABI = [
            "function buyToken(address tokenAddress) payable",
            "function sellToken(address tokenAddress, uint256 tokenAmount)",
            "function addSupportedToken(address tokenAddress)",
            "function supportedTokens(address) view returns (bool)",
            "function PRICE() view returns (uint256)",
            "event TokenBought(address buyer, address token, uint256 devAmount, uint256 tokenAmount)",
            "event TokenSold(address seller, address token, uint256 tokenAmount, uint256 devAmount)"
        ];
        
        const NFT_ABI = [
            "function mint(string) returns (uint256)",
            "function ownerOf(uint256) view returns (address)",
            "function strategy(uint256) view returns (string)",
            "function nextId() view returns (uint256)",
            "function totalSupply() view returns (uint256)",
            "function tokenByIndex(uint256) view returns (uint256)"
        ];

        // ========== Initialization ==========
        window.addEventListener('load', async () => {
            console.log("Multi-Chain Asset Management System Initialized");
            
            // Set up event listeners
            setupEventListeners();
            
            // Check if wallet is already connected
            if (window.ethereum) {
                try {
                    const accounts = await ethereum.request({ method: 'eth_accounts' });
                    if (accounts.length > 0) {
                        await initWallet();
                    }
                } catch (error) {
                    console.error("Auto-connection failed:", error);
                }
            }
            
            // Initialize cross-chain allocation
            initializeCrossChainAllocation();
        });

        function setupEventListeners() {
            // Strategy type change listener
            document.getElementById('strategyType').addEventListener('change', function() {
                updateStrategyTypeConfig();
            });
            
            // Cross-chain rebalance strategy change
            document.getElementById('crossChainRebalanceStrategy').addEventListener('change', function() {
                updateCrossChainRebalancePreview();
            });
            
            // Asset type tabs
            document.querySelectorAll('.asset-type-tabs .btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.asset-type-tabs .btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                });
            });
        }

        function initializeCrossChainAllocation() {
            // Initialize with default allocation
            crossChainAllocation = {
                'native_tokens': 50,
                'stablecoins': 30,
                'defi_tokens': 20
            };
        }

        // ========== Wallet Functions ==========
        async function connectWallet() {
            if (!window.ethereum) {
                alert('Please install MetaMask wallet');
                return;
            }

            try {
                document.getElementById('walletInfo').innerHTML = '<span class="loading"></span> Connecting...';
                
                await ethereum.request({ method: 'eth_requestAccounts' });
                await initWallet();
                
            } catch (error) {
                console.error('Connection failed:', error);
                document.getElementById('walletInfo').innerHTML = `
                    <button class="btn btn-primary" onclick="connectWallet()">
                        <i class="fas fa-wallet me-2"></i>Connect Wallet
                    </button>
                `;
                alert('Connection failed: ' + error.message);
            }
        }

        async function initWallet() {
            try {
                provider = new ethers.providers.Web3Provider(window.ethereum);
                signer = provider.getSigner();
                userAddress = await signer.getAddress();
                
                // Get current chain
                const network = await provider.getNetwork();
                currentChainId = network.chainId;
                const chain = CHAINS[currentChainId] || { name: 'Unknown Network' };
                
                // Update UI
                const shortAddr = shortenAddress(userAddress);
                let walletHtml = '';
                
                // Check balance on current chain
                const balance = await provider.getBalance(userAddress);
                const nativeBalance = parseFloat(ethers.utils.formatEther(balance));
                
                walletHtml = `
                    <div class="dropdown">
                        <button class="btn btn-success dropdown-toggle" type="button" data-bs-toggle="dropdown">
                            <i class="fas fa-wallet me-2"></i>${shortAddr}
                            <small class="d-block">${nativeBalance.toFixed(4)} ${chain.nativeToken || 'ETH'}</small>
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li><button class="dropdown-item" onclick="claimTestTokens()">
                                <i class="fas fa-faucet me-2"></i>Get Faucet
                            </button></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><button class="dropdown-item" onclick="switchNetwork(133)">
                                <i class="fas fa-fire me-2"></i>Switch to HashKey
                            </button></li>
                            <li><button class="dropdown-item" onclick="switchNetwork(10143)">
                                <i class="fas fa-bolt me-2"></i>Switch to Monad
                            </button></li>
                            <li><button class="dropdown-item" onclick="switchNetwork(1287)">
                                <i class="fas fa-moon me-2"></i>Switch to Moonbase
                            </button></li>
                            <li><button class="dropdown-item" onclick="switchNetwork(11155111)">
                                <i class="fas fa-ethereum me-2"></i>Switch to Sepolia
                            </button></li>
                        </ul>
                    </div>
                `;
                
                document.getElementById('walletInfo').innerHTML = walletHtml;
                
                // Load data
                await Promise.all([
                    loadMultiChainAssets(),
                    loadAllChainNFTs()
                ]);
                
                // Update system status
                updateSystemStatus();
                
            } catch (error) {
                console.error('Wallet initialization failed:', error);
            }
        }

        async function switchNetwork(chainId) {
            if (!window.ethereum) {
                alert('Please install MetaMask wallet');
                return;
            }
            
            try {
                const chain = CHAINS[chainId];
                if (!chain) {
                    alert('Chain not supported');
                    return;
                }
                
                await window.ethereum.request({
                    method: 'wallet_switchEthereumChain',
                    params: [{ chainId: `0x${chainId.toString(16)}` }],
                });
                
                // Reload wallet connection
                setTimeout(async () => {
                    await initWallet();
                }, 1000);
                
            } catch (switchError) {
                if (switchError.code === 4902) {
                    try {
                        const chain = CHAINS[chainId];
                        await window.ethereum.request({
                            method: 'wallet_addEthereumChain',
                            params: [{
                                chainId: `0x${chainId.toString(16)}`,
                                chainName: chain.name,
                                nativeCurrency: {
                                    name: chain.nativeToken,
                                    symbol: chain.nativeToken,
                                    decimals: 18
                                },
                                rpcUrls: [chain.rpcUrl],
                                blockExplorerUrls: [chain.explorer]
                            }],
                        });
                    } catch (addError) {
                        console.error('Failed to add chain:', addError);
                        alert(`Failed to add ${chain.name} to MetaMask`);
                    }
                } else {
                    console.error('Failed to switch chain:', switchError);
                }
            }
        }

        // ========== Multi-Chain Asset Management ==========
        async function loadMultiChainAssets() {
            if (!userAddress) {
                document.getElementById('multiChainAssetsContainer').innerHTML = `
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Please connect your wallet first
                    </div>
                `;
                return;
            }

            try {
                document.getElementById('multiChainAssetsContainer').innerHTML = `
                    <div class="text-center py-4">
                        <span class="loading"></span> Loading multi-chain assets...
                    </div>
                `;

                allChainAssets = [];
                let totalPortfolioValue = 0;
                
                // Load assets for each chain
                const assetPromises = Object.entries(CHAINS).map(async ([chainId, chain]) => {
                    if (activeChainFilter !== 'all' && parseInt(chainId) !== parseInt(activeChainFilter)) {
                        return null;
                    }
                    
                    try {
                        // Create provider for this chain
                        const chainProvider = new ethers.providers.JsonRpcProvider(chain.rpcUrl);
                        
                        // Get native token balance
                        const nativeBalance = await chainProvider.getBalance(userAddress);
                        const nativeAmount = parseFloat(ethers.utils.formatEther(nativeBalance));
                        
                        let stableBalance = 0;
                        let stableAmount = 0;
                        
                        // Get stable token balance if exists
                        if (chain.stableToken && chain.stableToken.address) {
                            try {
                                const tokenContract = new ethers.Contract(
                                    chain.stableToken.address, 
                                    TOKEN_ABI, 
                                    chainProvider
                                );
                                const balance = await tokenContract.balanceOf(userAddress);
                                stableAmount = parseFloat(ethers.utils.formatEther(balance));
                                stableBalance = stableAmount; // Simple 1:1 conversion for demo
                            } catch (e) {
                                console.log(`Failed to get stable token balance on ${chain.name}:`, e);
                            }
                        }
                        
                        const chainValue = nativeAmount + stableBalance;
                        totalPortfolioValue += chainValue;
                        
                        const chainAssets = {
                            chainId: parseInt(chainId),
                            chainName: chain.name,
                            chainSymbol: chain.symbol,
                            nativeToken: chain.nativeToken,
                            stableToken: chain.stableToken,
                            nativeAmount: nativeAmount,
                            stableAmount: stableAmount,
                            stableBalance: stableBalance,
                            chainValue: chainValue,
                            hasDex: chain.dex !== null,
                            color: chain.color
                        };
                        
                        allChainAssets.push(chainAssets);
                        
                        return chainAssets;
                    } catch (error) {
                        console.error(`Failed to load assets for ${chain.name}:`, error);
                        return null;
                    }
                });

                await Promise.all(assetPromises);
                
                // Filter out null results
                allChainAssets = allChainAssets.filter(asset => asset !== null);
                
                // Update UI
                updateMultiChainAssetsDisplay();
                updateCrossChainOverview();
                updatePortfolioSummary(totalPortfolioValue);
                updateAssetDistributionChart();
                updateCrossChainHoldings();
                updateCrossChainAllocationDisplay();
                updateChainRatioControls();
                
            } catch (error) {
                console.error('Failed to load multi-chain assets:', error);
                document.getElementById('multiChainAssetsContainer').innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-circle me-2"></i>
                        Failed to load assets: ${error.message}
                    </div>
                `;
            }
        }

        function updateMultiChainAssetsDisplay() {
            const container = document.getElementById('multiChainAssetsContainer');
            
            if (allChainAssets.length === 0) {
                container.innerHTML = `
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        No assets found on selected chains
                    </div>
                `;
                return;
            }
            
            // Filter assets by type
            let filteredAssets = allChainAssets;
            if (activeAssetType === 'native') {
                // Only show chains with native tokens
                filteredAssets = allChainAssets.filter(asset => asset.nativeAmount > 0);
            } else if (activeAssetType === 'stable') {
                // Only show chains with stablecoins
                filteredAssets = allChainAssets.filter(asset => asset.stableToken && asset.stableAmount > 0);
            }
            
            if (filteredAssets.length === 0) {
                container.innerHTML = `
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        No ${activeAssetType} assets found
                    </div>
                `;
                return;
            }
            
            let html = '';
            
            filteredAssets.forEach(asset => {
                const chainBadgeClass = getChainBadgeClass(asset.chainId);
                const totalValue = asset.chainValue;
                const nativePercent = totalValue > 0 ? (asset.nativeAmount / totalValue * 100).toFixed(1) : 0;
                const stablePercent = totalValue > 0 ? (asset.stableBalance / totalValue * 100).toFixed(1) : 0;
                
                // Get current ratio settings
                const ratio = chainAssetRatios[asset.chainId] || { native: 50, stable: 50 };
                
                html += `
                    <div class="chain-group mb-4">
                        <div class="chain-header">
                            <h5>
                                <span class="chain-badge ${chainBadgeClass}">${asset.chainName}</span>
                                <span class="text-muted">Total: ${totalValue.toFixed(4)}</span>
                                ${asset.hasDex ? '<span class="badge bg-success ms-2">DEX Available</span>' : ''}
                            </h5>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-dark mb-0">
                                <thead>
                                    <tr>
                                        <th>Asset</th>
                                        <th>Amount</th>
                                        <th>Value</th>
                                        <th>Current %</th>
                                        <th>Target %</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>
                                            <span class="asset-icon ${getAssetIconClass(asset.nativeToken)}">
                                                <i class="fas fa-${getAssetIcon(asset.nativeToken)}"></i>
                                            </span>
                                            <strong>${asset.nativeToken}</strong>
                                            <small class="text-muted ms-2">Native</small>
                                        </td>
                                        <td>${asset.nativeAmount.toFixed(4)}</td>
                                        <td>${asset.nativeAmount.toFixed(4)}</td>
                                        <td>${nativePercent}%</td>
                                        <td>
                                            <div class="input-group input-group-sm" style="width: 120px;">
                                                <input type="number" class="form-control form-control-sm" 
                                                       id="native-ratio-${asset.chainId}" 
                                                       value="${ratio.native}" min="0" max="100"
                                                       onchange="updateChainRatio(${asset.chainId}, 'native', this.value)">
                                                <span class="input-group-text">%</span>
                                            </div>
                                        </td>
                                        <td>
                                            <div class="balance-actions">
                                                <button class="btn btn-sm btn-outline-success" onclick="showChainTradeModal(${asset.chainId}, '${asset.nativeToken}', 'buy')">
                                                    <i class="fas fa-shopping-cart"></i> Buy
                                                </button>
                                                <button class="btn btn-sm btn-outline-warning" onclick="showChainTradeModal(${asset.chainId}, '${asset.nativeToken}', 'sell')">
                                                    <i class="fas fa-money-bill-wave"></i> Sell
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                `;
                
                if (asset.stableToken && asset.stableAmount > 0) {
                    html += `
                                    <tr>
                                        <td>
                                            <span class="asset-icon ${getAssetIconClass(asset.stableToken.symbol)}">
                                                <i class="fas fa-${getAssetIcon(asset.stableToken.symbol)}"></i>
                                            </span>
                                            <strong>${asset.stableToken.symbol}</strong>
                                            <small class="text-muted ms-2">Stable</small>
                                        </td>
                                        <td>${asset.stableAmount.toFixed(4)}</td>
                                        <td>${asset.stableBalance.toFixed(4)}</td>
                                        <td>${stablePercent}%</td>
                                        <td>
                                            <div class="input-group input-group-sm" style="width: 120px;">
                                                <input type="number" class="form-control form-control-sm" 
                                                       id="stable-ratio-${asset.chainId}" 
                                                       value="${ratio.stable}" min="0" max="100"
                                                       onchange="updateChainRatio(${asset.chainId}, 'stable', this.value)">
                                                <span class="input-group-text">%</span>
                                            </div>
                                        </td>
                                        <td>
                                            ${asset.chainId === currentChainId && asset.hasDex ? `
                                                <div class="balance-actions">
                                                    <button class="btn btn-sm btn-outline-success" onclick="showChainTradeModal(${asset.chainId}, '${asset.stableToken.symbol}', 'buy')">
                                                        <i class="fas fa-shopping-cart"></i> Buy
                                                    </button>
                                                    <button class="btn btn-sm btn-outline-warning" onclick="showChainTradeModal(${asset.chainId}, '${asset.stableToken.symbol}', 'sell')">
                                                        <i class="fas fa-money-bill-wave"></i> Sell
                                                    </button>
                                                </div>
                                            ` : asset.chainId === currentChainId ? `
                                                <span class="text-muted small">No DEX</span>
                                            ` : `
                                                <button class="btn btn-sm btn-outline-light" onclick="switchNetwork(${asset.chainId})">
                                                    <i class="fas fa-exchange-alt me-1"></i>Switch
                                                </button>
                                            `}
                                        </td>
                                    </tr>
                    `;
                }
                
                html += `
                                    <tr class="table-active">
                                        <td colspan="2"><strong>Chain Total</strong></td>
                                        <td><strong>${totalValue.toFixed(4)}</strong></td>
                                        <td>100%</td>
                                        <td>100%</td>
                                        <td>
                                            ${asset.hasDex ? `
                                                <button class="btn btn-sm btn-info" onclick="rebalanceChainAssets(${asset.chainId})">
                                                    <i class="fas fa-balance-scale me-1"></i>Rebalance Chain
                                                </button>
                                            ` : '<span class="text-muted small">No DEX</span>'}
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        
                        <!-- Chain Asset Adjustment Panel -->
                        <div class="asset-adjustment-panel">
                            <h6><i class="fas fa-sliders-h"></i> Asset Ratio Adjustment</h6>
                            <div class="chain-asset-controls">
                                <div class="asset-control-group">
                                    <h6><i class="fas fa-fire" style="color: ${asset.color}"></i> ${asset.nativeToken}</h6>
                                    <div class="d-flex align-items-center gap-2">
                                        <input type="range" class="form-range" 
                                               id="native-slider-${asset.chainId}"
                                               value="${ratio.native}" min="0" max="100"
                                               oninput="updateChainRatioFromSlider(${asset.chainId}, 'native', this.value)">
                                        <input type="number" class="form-control form-control-sm" 
                                               style="width: 70px;"
                                               id="native-input-${asset.chainId}"
                                               value="${ratio.native}" min="0" max="100"
                                               onchange="updateChainRatio(${asset.chainId}, 'native', this.value)">
                                        <span>%</span>
                                    </div>
                                </div>
                                ${asset.stableToken ? `
                                <div class="asset-control-group">
                                    <h6><i class="fas fa-dollar-sign text-success"></i> ${asset.stableToken.symbol}</h6>
                                    <div class="d-flex align-items-center gap-2">
                                        <input type="range" class="form-range" 
                                               id="stable-slider-${asset.chainId}"
                                               value="${ratio.stable}" min="0" max="100"
                                               oninput="updateChainRatioFromSlider(${asset.chainId}, 'stable', this.value)">
                                        <input type="number" class="form-control form-control-sm" 
                                               style="width: 70px;"
                                               id="stable-input-${asset.chainId}"
                                               value="${ratio.stable}" min="0" max="100"
                                               onchange="updateChainRatio(${asset.chainId}, 'stable', this.value)">
                                        <span>%</span>
                                    </div>
                                </div>
                                ` : ''}
                            </div>
                            <div class="mt-2">
                                <button class="btn btn-sm btn-outline-primary" onclick="applyChainRatio(${asset.chainId})">
                                    <i class="fas fa-check me-1"></i>Apply Ratio
                                </button>
                                <button class="btn btn-sm btn-outline-secondary ms-2" onclick="autoBalanceChainRatio(${asset.chainId})">
                                    <i class="fas fa-magic me-1"></i>Auto Balance
                                </button>
                                <button class="btn btn-sm btn-outline-warning ms-2" onclick="showAdvancedChainRatioModal(${asset.chainId})">
                                    <i class="fas fa-cog me-1"></i>Advanced
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        // ========== DEX Swap Functions ==========
        function selectDexChain(chainId) {
            selectedDexChain = chainId;
            const chain = CHAINS[chainId];
            
            if (!chain) {
                alert('Chain not supported');
                return;
            }
            
            // Update UI
            document.querySelectorAll('#dex .btn-outline-light').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Load DEX interface
            loadDexInterface(chainId);
            loadDexLiquidityInfo(chainId);
            loadQuickSwapForm(chainId);
        }

        function loadDexInterface(chainId) {
            const container = document.getElementById('dexSwapContainer');
            const chain = CHAINS[chainId];
            
            if (!chain || !chain.dex) {
                container.innerHTML = `
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        ${chain.name} does not have DEX support
                    </div>
                `;
                return;
            }
            
            container.innerHTML = `
                <div class="trade-section">
                    <h6><i class="fas fa-exchange-alt me-2"></i>Swap on ${chain.name}</h6>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">From</label>
                                <select class="form-control" id="fromAsset">
                                    <option value="native">${chain.nativeToken} (Native)</option>
                                    ${chain.stableToken ? `<option value="stable">${chain.stableToken.symbol} (Stable)</option>` : ''}
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">To</label>
                                <select class="form-control" id="toAsset">
                                    ${chain.stableToken ? `<option value="stable">${chain.stableToken.symbol} (Stable)</option>` : ''}
                                    <option value="native">${chain.nativeToken} (Native)</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Amount to Swap</label>
                        <div class="input-group">
                            <input type="number" class="form-control" id="swapAmount" 
                                   placeholder="Enter amount" min="0.001" step="0.001">
                            <button class="btn btn-outline-secondary" type="button" onclick="setMaxSwapAmount()">
                                MAX
                            </button>
                        </div>
                        <small class="text-muted" id="balanceInfo"></small>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Slippage Tolerance</label>
                        <div class="input-group">
                            <input type="number" class="form-control" id="slippage" value="0.5" min="0.1" max="5" step="0.1">
                            <span class="input-group-text">%</span>
                        </div>
                    </div>
                    
                    <div id="swapPreview" class="trade-preview mb-3">
                        <div class="trade-preview-item">
                            <span class="label">Exchange Rate:</span>
                            <span class="value" id="exchangeRate">1 ${chain.nativeToken} = 1.05 ${chain.stableToken ? chain.stableToken.symbol : 'USD'}</span>
                        </div>
                        <div class="trade-preview-item">
                            <span class="label">You Receive:</span>
                            <span class="value" id="receiveAmount">0</span>
                        </div>
                        <div class="trade-preview-item">
                            <span class="label">Price Impact:</span>
                            <span class="value" id="priceImpact">0.1%</span>
                        </div>
                        <div class="trade-preview-item">
                            <span class="label">DEX Fee:</span>
                            <span class="value">0.3%</span>
                        </div>
                    </div>
                    
                    <div class="d-grid gap-2">
                        <button class="btn btn-primary" onclick="prepareSwap()">
                            <i class="fas fa-exchange-alt me-2"></i>Preview Swap
                        </button>
                        <button class="btn btn-success" id="executeSwapBtn" style="display: none;" onclick="executeSwap()">
                            <i class="fas fa-check me-2"></i>Execute Swap
                        </button>
                    </div>
                </div>
            `;
            
            // Add event listeners
            document.getElementById('fromAsset').addEventListener('change', updateSwapPreview);
            document.getElementById('toAsset').addEventListener('change', updateSwapPreview);
            document.getElementById('swapAmount').addEventListener('input', updateSwapPreview);
            
            // Update balance info
            updateBalanceInfo(chainId);
        }

        function updateBalanceInfo(chainId) {
            const chain = CHAINS[chainId];
            const asset = allChainAssets.find(a => a.chainId === chainId);
            
            if (!asset) return;
            
            const fromAsset = document.getElementById('fromAsset').value;
            let balance = 0;
            
            if (fromAsset === 'native') {
                balance = asset.nativeAmount;
            } else if (fromAsset === 'stable' && chain.stableToken) {
                balance = asset.stableAmount;
            }
            
            document.getElementById('balanceInfo').textContent = `Balance: ${balance.toFixed(4)}`;
        }

        function setMaxSwapAmount() {
            const chainId = selectedDexChain;
            const chain = CHAINS[chainId];
            const asset = allChainAssets.find(a => a.chainId === chainId);
            
            if (!asset) return;
            
            const fromAsset = document.getElementById('fromAsset').value;
            let balance = 0;
            
            if (fromAsset === 'native') {
                balance = asset.nativeAmount;
            } else if (fromAsset === 'stable' && chain.stableToken) {
                balance = asset.stableAmount;
            }
            
            // Set to 90% of balance to account for gas
            const maxAmount = balance * 0.9;
            document.getElementById('swapAmount').value = maxAmount.toFixed(4);
            
            updateSwapPreview();
        }

        function updateSwapPreview() {
            const chainId = selectedDexChain;
            const chain = CHAINS[chainId];
            
            if (!chain) return;
            
            const fromAsset = document.getElementById('fromAsset').value;
            const toAsset = document.getElementById('toAsset').value;
            const amount = parseFloat(document.getElementById('swapAmount').value) || 0;
            
            // Simple exchange rate: 1 native = 1.05 stable, 1 stable = 0.95 native
            let exchangeRate = 1.05;
            let receiveAmount = 0;
            
            if (fromAsset === 'native' && toAsset === 'stable') {
                // Buying stable with native
                receiveAmount = amount * exchangeRate;
                document.getElementById('exchangeRate').textContent = `1 ${chain.nativeToken} = ${exchangeRate} ${chain.stableToken ? chain.stableToken.symbol : 'USD'}`;
            } else if (fromAsset === 'stable' && toAsset === 'native') {
                // Buying native with stable
                receiveAmount = amount / exchangeRate;
                document.getElementById('exchangeRate').textContent = `1 ${chain.stableToken ? chain.stableToken.symbol : 'USD'} = ${(1/exchangeRate).toFixed(4)} ${chain.nativeToken}`;
            }
            
            // Calculate fee (0.3%)
            const fee = receiveAmount * 0.003;
            receiveAmount -= fee;
            
            // Update display
            document.getElementById('receiveAmount').textContent = `${receiveAmount.toFixed(4)} ${toAsset === 'native' ? chain.nativeToken : (chain.stableToken ? chain.stableToken.symbol : 'USD')}`;
            
            // Show/hide execute button
            const executeBtn = document.getElementById('executeSwapBtn');
            if (amount > 0 && receiveAmount > 0) {
                executeBtn.style.display = 'block';
            } else {
                executeBtn.style.display = 'none';
            }
        }

        function prepareSwap() {
            const chainId = selectedDexChain;
            const chain = CHAINS[chainId];
            const amount = parseFloat(document.getElementById('swapAmount').value) || 0;
            
            if (amount <= 0) {
                alert('Please enter a valid amount');
                return;
            }
            
            // Check if we're on the right chain
            if (currentChainId !== chainId) {
                alert(`Please switch to ${chain.name} first to execute swap`);
                return;
            }
            
            // Show confirmation
            const fromAsset = document.getElementById('fromAsset').value;
            const toAsset = document.getElementById('toAsset').value;
            const receiveAmount = document.getElementById('receiveAmount').textContent;
            
            const confirmMessage = `Confirm swap?\n\nSwap ${amount.toFixed(4)} ${fromAsset === 'native' ? chain.nativeToken : (chain.stableToken ? chain.stableToken.symbol : 'USD')} for ${receiveAmount}\n\nExchange Rate: ${document.getElementById('exchangeRate').textContent}`;
            
            if (confirm(confirmMessage)) {
                // Enable execute button
                document.getElementById('executeSwapBtn').style.display = 'block';
            }
        }

        async function executeSwap() {
            const chainId = selectedDexChain;
            const chain = CHAINS[chainId];
            
            if (!chain || !chain.dex) {
                alert('DEX not available on this chain');
                return;
            }
            
            if (!userAddress) {
                alert('Please connect your wallet first');
                return;
            }
            
            if (currentChainId !== chainId) {
                alert(`Please switch to ${chain.name} first`);
                return;
            }
            
            const fromAsset = document.getElementById('fromAsset').value;
            const toAsset = document.getElementById('toAsset').value;
            const amount = parseFloat(document.getElementById('swapAmount').value) || 0;
            
            if (amount <= 0) {
                alert('Please enter a valid amount');
                return;
            }
            
            try {
                // Show transaction status
                const statusDiv = document.getElementById('dexSwapStatus');
                statusDiv.innerHTML = `
                    <div class="transaction-status">
                        <div class="transaction-step pending">
                            <i class="fas fa-spinner fa-spin"></i>
                            <span>Preparing swap transaction...</span>
                        </div>
                        <div class="transaction-step">
                            <i class="fas fa-file-signature"></i>
                            <span>Waiting for approval...</span>
                        </div>
                        <div class="transaction-step">
                            <i class="fas fa-exchange-alt"></i>
                            <span>Executing swap...</span>
                        </div>
                        <div class="transaction-step">
                            <i class="fas fa-check-circle"></i>
                            <span>Updating balances...</span>
                        </div>
                    </div>
                `;
                
                // Get DEX contract
                const dexContract = new ethers.Contract(chain.dex, TINYDEX_ABI, signer);
                
                if (fromAsset === 'native' && toAsset === 'stable') {
                    // Buying stable with native
                    // Check if token is supported
                    const isSupported = await dexContract.supportedTokens(chain.stableToken.address);
                    if (!isSupported) {
                        throw new Error(`Token ${chain.stableToken.symbol} is not supported by DEX`);
                    }
                    
                    // Execute buyToken
                    const tx = await dexContract.buyToken(chain.stableToken.address, {
                        value: ethers.utils.parseEther(amount.toString())
                    });
                    
                    statusDiv.innerHTML = `
                        <div class="transaction-status">
                            <div class="transaction-step completed">
                                <i class="fas fa-check-circle"></i>
                                <span>Transaction prepared</span>
                            </div>
                            <div class="transaction-step pending">
                                <i class="fas fa-spinner fa-spin"></i>
                                <span>Transaction sent: ${tx.hash.substring(0, 20)}...</span>
                            </div>
                            <div class="transaction-step">
                                <i class="fas fa-exchange-alt"></i>
                                <span>Waiting for confirmation...</span>
                            </div>
                            <div class="transaction-step">
                                <i class="fas fa-check-circle"></i>
                                <span>Updating balances...</span>
                            </div>
                        </div>
                    `;
                    
                    // Wait for transaction
                    await tx.wait();
                    
                } else if (fromAsset === 'stable' && toAsset === 'native') {
                    // Selling stable for native
                    // Check if token is supported
                    const isSupported = await dexContract.supportedTokens(chain.stableToken.address);
                    if (!isSupported) {
                        throw new Error(`Token ${chain.stableToken.symbol} is not supported by DEX`);
                    }
                    
                    // Approve DEX to spend tokens
                    const tokenContract = new ethers.Contract(chain.stableToken.address, TOKEN_ABI, signer);
                    const approveTx = await tokenContract.approve(
                        chain.dex,
                        ethers.utils.parseEther(amount.toString())
                    );
                    await approveTx.wait();
                    
                    // Execute sellToken
                    const tx = await dexContract.sellToken(
                        chain.stableToken.address,
                        ethers.utils.parseEther(amount.toString())
                    );
                    
                    statusDiv.innerHTML = `
                        <div class="transaction-status">
                            <div class="transaction-step completed">
                                <i class="fas fa-check-circle"></i>
                                <span>Approval completed</span>
                            </div>
                            <div class="transaction-step pending">
                                <i class="fas fa-spinner fa-spin"></i>
                                <span>Transaction sent: ${tx.hash.substring(0, 20)}...</span>
                            </div>
                            <div class="transaction-step">
                                <i class="fas fa-exchange-alt"></i>
                                <span>Waiting for confirmation...</span>
                            </div>
                            <div class="transaction-step">
                                <i class="fas fa-check-circle"></i>
                                <span>Updating balances...</span>
                            </div>
                        </div>
                    `;
                    
                    // Wait for transaction
                    await tx.wait();
                }
                
                // Update balances
                statusDiv.innerHTML = `
                    <div class="transaction-status">
                        <div class="transaction-step completed">
                            <i class="fas fa-check-circle"></i>
                            <span>Transaction prepared</span>
                        </div>
                        <div class="transaction-step completed">
                            <i class="fas fa-check-circle"></i>
                            <span>Transaction confirmed</span>
                        </div>
                        <div class="transaction-step completed">
                            <i class="fas fa-check-circle"></i>
                            <span>Swap executed</span>
                        </div>
                        <div class="transaction-step pending">
                            <i class="fas fa-spinner fa-spin"></i>
                            <span>Updating balances...</span>
                        </div>
                    </div>
                `;
                
                // Reload assets
                await loadMultiChainAssets();
                
                // Update status
                statusDiv.innerHTML = `
                    <div class="alert alert-success">
                        <i class="fas fa-check-circle me-2"></i>
                        Swap executed successfully!
                    </div>
                `;
                
                // Clear form
                document.getElementById('swapAmount').value = '';
                document.getElementById('executeSwapBtn').style.display = 'none';
                
                // Add to trade history
                addTradeHistory(chainId, fromAsset, toAsset, amount);
                
            } catch (error) {
                console.error('Swap failed:', error);
                document.getElementById('dexSwapStatus').innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-times-circle me-2"></i>
                        Swap failed: ${error.message}
                    </div>
                `;
            }
        }

        function loadDexLiquidityInfo(chainId) {
            const container = document.getElementById('dexLiquidityInfo');
            const chain = CHAINS[chainId];
            
            if (!chain || !chain.dex) {
                container.innerHTML = `
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        No DEX available on ${chain.name}
                    </div>
                `;
                return;
            }
            
            // For demo purposes, show mock liquidity info
            container.innerHTML = `
                <div class="row">
                    <div class="col-md-6">
                        <div class="stats-card">
                            <div class="d-flex justify-content-between align-items-center">
                                <span>${chain.nativeToken} Liquidity</span>
                                <span class="fw-bold">1,000,000</span>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="stats-card">
                            <div class="d-flex justify-content-between align-items-center">
                                <span>${chain.stableToken ? chain.stableToken.symbol : 'Stable'} Liquidity</span>
                                <span class="fw-bold">1,050,000</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-md-6">
                        <div class="stats-card">
                            <div class="d-flex justify-content-between align-items-center">
                                <span>24h Volume</span>
                                <span class="fw-bold">50,000</span>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="stats-card">
                            <div class="d-flex justify-content-between align-items-center">
                                <span>Exchange Rate</span>
                                <span class="fw-bold">1:1.05</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="mt-3">
                    <small class="text-muted">TinyDEX Contract: ${shortenAddress(chain.dex)}</small>
                </div>
            `;
        }

        function loadQuickSwapForm(chainId) {
            const container = document.getElementById('quickSwapForm');
            const chain = CHAINS[chainId];
            
            if (!chain || !chain.dex) {
                container.innerHTML = `
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        No DEX available
                    </div>
                `;
                return;
            }
            
            container.innerHTML = `
                <div class="mb-3">
                    <label class="form-label">Quick Swap Amount</label>
                    <input type="number" class="form-control" id="quickAmount" 
                           placeholder="0.1" min="0.001" step="0.001">
                </div>
                
                <div class="mb-3">
                    <label class="form-label">Swap Direction</label>
                    <div class="d-grid gap-2">
                        <button class="btn btn-outline-primary" onclick="quickSwap('buy')">
                            <i class="fas fa-arrow-right me-2"></i>Buy ${chain.stableToken ? chain.stableToken.symbol : 'Stable'}
                        </button>
                        <button class="btn btn-outline-warning" onclick="quickSwap('sell')">
                            <i class="fas fa-arrow-left me-2"></i>Sell ${chain.stableToken ? chain.stableToken.symbol : 'Stable'}
                        </button>
                    </div>
                </div>
                
                <div class="alert alert-info small">
                    <i class="fas fa-info-circle me-2"></i>
                    Quick swap uses default settings: 0.5% slippage
                </div>
            `;
        }

        function quickSwap(direction) {
            const chainId = selectedDexChain;
            const chain = CHAINS[chainId];
            const amount = parseFloat(document.getElementById('quickAmount').value) || 0.1;
            
            if (amount <= 0) {
                alert('Please enter a valid amount');
                return;
            }
            
            // Set up the swap modal
            const modal = new bootstrap.Modal(document.getElementById('dexSwapModal'));
            const content = document.getElementById('dexSwapContent');
            
            let fromAsset, toAsset;
            if (direction === 'buy') {
                fromAsset = 'native';
                toAsset = 'stable';
            } else {
                fromAsset = 'stable';
                toAsset = 'native';
            }
            
            const exchangeRate = 1.05;
            let receiveAmount = direction === 'buy' ? amount * exchangeRate : amount / exchangeRate;
            const fee = receiveAmount * 0.003;
            receiveAmount -= fee;
            
            content.innerHTML = `
                <div class="trade-section">
                    <h6><i class="fas fa-bolt me-2"></i>Quick Swap Preview</h6>
                    
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        ${direction === 'buy' ? 'Buying' : 'Selling'} ${amount.toFixed(4)} ${direction === 'buy' ? chain.nativeToken : (chain.stableToken ? chain.stableToken.symbol : 'USD')}
                    </div>
                    
                    <div class="trade-preview">
                        <div class="trade-preview-item">
                            <span class="label">From:</span>
                            <span class="value">${amount.toFixed(4)} ${direction === 'buy' ? chain.nativeToken : (chain.stableToken ? chain.stableToken.symbol : 'USD')}</span>
                        </div>
                        <div class="trade-preview-item">
                            <span class="label">To:</span>
                            <span class="value">${receiveAmount.toFixed(4)} ${direction === 'buy' ? (chain.stableToken ? chain.stableToken.symbol : 'USD') : chain.nativeToken}</span>
                        </div>
                        <div class="trade-preview-item">
                            <span class="label">Exchange Rate:</span>
                            <span class="value">1 ${chain.nativeToken} = ${exchangeRate} ${chain.stableToken ? chain.stableToken.symbol : 'USD'}</span>
                        </div>
                        <div class="trade-preview-item">
                            <span class="label">Fee:</span>
                            <span class="value">${fee.toFixed(4)}</span>
                        </div>
                    </div>
                    
                    <div class="mt-3">
                        <button class="btn btn-primary w-100" onclick="executeQuickSwap(${chainId}, '${direction}', ${amount})">
                            <i class="fas fa-check me-2"></i>Confirm Quick Swap
                        </button>
                    </div>
                </div>
            `;
            
            modal.show();
        }

        async function executeQuickSwap(chainId, direction, amount) {
            const chain = CHAINS[chainId];
            
            if (!userAddress) {
                alert('Please connect your wallet first');
                return;
            }
            
            if (currentChainId !== chainId) {
                alert(`Please switch to ${chain.name} first`);
                return;
            }
            
            try {
                const statusDiv = document.getElementById('dexSwapStatus');
                statusDiv.innerHTML = `
                    <div class="transaction-status">
                        <div class="transaction-step pending">
                            <i class="fas fa-spinner fa-spin"></i>
                            <span>Executing quick swap...</span>
                        </div>
                    </div>
                `;
                
                // Get DEX contract
                const dexContract = new ethers.Contract(chain.dex, TINYDEX_ABI, signer);
                
                if (direction === 'buy') {
                    // Buying stable with native
                    const tx = await dexContract.buyToken(chain.stableToken.address, {
                        value: ethers.utils.parseEther(amount.toString())
                    });
                    await tx.wait();
                } else {
                    // Selling stable for native
                    const tokenContract = new ethers.Contract(chain.stableToken.address, TOKEN_ABI, signer);
                    const approveTx = await tokenContract.approve(
                        chain.dex,
                        ethers.utils.parseEther(amount.toString())
                    );
                    await approveTx.wait();
                    
                    const tx = await dexContract.sellToken(
                        chain.stableToken.address,
                        ethers.utils.parseEther(amount.toString())
                    );
                    await tx.wait();
                }
                
                statusDiv.innerHTML = `
                    <div class="alert alert-success">
                        <i class="fas fa-check-circle me-2"></i>
                        Quick swap executed successfully!
                    </div>
                `;
                
                // Reload assets
                await loadMultiChainAssets();
                
                // Close modal
                bootstrap.Modal.getInstance(document.getElementById('dexSwapModal')).hide();
                
                // Add to trade history
                addTradeHistory(chainId, direction === 'buy' ? 'native' : 'stable', direction === 'buy' ? 'stable' : 'native', amount);
                
            } catch (error) {
                console.error('Quick swap failed:', error);
                document.getElementById('dexSwapStatus').innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-times-circle me-2"></i>
                        Quick swap failed: ${error.message}
                    </div>
                `;
            }
        }

        function addTradeHistory(chainId, fromAsset, toAsset, amount) {
            const container = document.getElementById('tradeHistory');
            const chain = CHAINS[chainId];
            const now = new Date();
            const timeStr = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            
            const historyItem = `
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <div>
                        <small class="text-muted">${timeStr}</small>
                        <div class="small">
                            ${fromAsset === 'native' ? chain.nativeToken : (chain.stableToken ? chain.stableToken.symbol : 'USD')}  
                            ${toAsset === 'native' ? chain.nativeToken : (chain.stableToken ? chain.stableToken.symbol : 'USD')}
                        </div>
                    </div>
                    <div class="text-end">
                        <div class="small fw-bold">${amount.toFixed(4)}</div>
                        <small class="text-success">Completed</small>
                    </div>
                </div>
            `;
            
            container.innerHTML = historyItem + container.innerHTML;
            
            // Limit to 10 items
            const items = container.querySelectorAll('.d-flex');
            if (items.length > 10) {
                items[items.length - 1].remove();
            }
        }

        // ========== Chain Asset Ratio Functions ==========
        function updateChainRatio(chainId, assetType, value) {
            const intValue = parseInt(value) || 0;
            
            // Ensure value is between 0 and 100
            if (intValue < 0) value = 0;
            if (intValue > 100) value = 100;
            
            // Update the ratio object
            if (!chainAssetRatios[chainId]) {
                chainAssetRatios[chainId] = { native: 50, stable: 50 };
            }
            
            chainAssetRatios[chainId][assetType] = intValue;
            
            // Update the other asset type to maintain 100% total
            const otherType = assetType === 'native' ? 'stable' : 'native';
            const otherValue = 100 - intValue;
            chainAssetRatios[chainId][otherType] = otherValue;
            
            // Update UI
            updateRatioInputs(chainId);
            
            // Show modified badge
            const nativeInput = document.getElementById(`native-ratio-${chainId}`);
            const stableInput = document.getElementById(`stable-ratio-${chainId}`);
            if (nativeInput) nativeInput.classList.add('modified');
            if (stableInput) stableInput.classList.add('modified');
        }

        function updateChainRatioFromSlider(chainId, assetType, value) {
            updateChainRatio(chainId, assetType, value);
        }

        function updateRatioInputs(chainId) {
            const ratio = chainAssetRatios[chainId];
            if (!ratio) return;
            
            // Update all input fields for this chain
            const nativeInput = document.getElementById(`native-ratio-${chainId}`);
            const stableInput = document.getElementById(`stable-ratio-${chainId}`);
            const nativeSlider = document.getElementById(`native-slider-${chainId}`);
            const stableSlider = document.getElementById(`stable-slider-${chainId}`);
            const nativeInput2 = document.getElementById(`native-input-${chainId}`);
            const stableInput2 = document.getElementById(`stable-input-${chainId}`);
            
            if (nativeInput) nativeInput.value = ratio.native;
            if (stableInput) stableInput.value = ratio.stable;
            if (nativeSlider) nativeSlider.value = ratio.native;
            if (stableSlider) stableSlider.value = ratio.stable;
            if (nativeInput2) nativeInput2.value = ratio.native;
            if (stableInput2) stableInput2.value = ratio.stable;
        }

        function applyChainRatio(chainId) {
            const ratio = chainAssetRatios[chainId];
            const asset = allChainAssets.find(a => a.chainId === chainId);
            
            if (!asset || !ratio) {
                alert('Chain not found');
                return;
            }
            
            // Calculate rebalancing needs
            const totalValue = asset.chainValue;
            const targetNative = (ratio.native / 100) * totalValue;
            const targetStable = (ratio.stable / 100) * totalValue;
            const currentNative = asset.nativeAmount;
            const currentStable = asset.stableBalance;
            
            let actions = [];
            
            if (currentNative < targetNative) {
                const buyAmount = targetNative - currentNative;
                actions.push(`Buy ${buyAmount.toFixed(4)} ${asset.nativeToken}`);
            } else if (currentNative > targetNative) {
                const sellAmount = currentNative - targetNative;
                actions.push(`Sell ${sellAmount.toFixed(4)} ${asset.nativeToken}`);
            }
            
            if (asset.stableToken && currentStable < targetStable) {
                const buyAmount = targetStable - currentStable;
                actions.push(`Buy ${buyAmount.toFixed(4)} ${asset.stableToken.symbol}`);
            } else if (asset.stableToken && currentStable > targetStable) {
                const sellAmount = currentStable - targetStable;
                actions.push(`Sell ${sellAmount.toFixed(4)} ${asset.stableToken.symbol}`);
            }
            
            if (actions.length === 0) {
                alert(`Portfolio on ${asset.chainName} already matches target ratios (${ratio.native}% ${asset.nativeToken}, ${ratio.stable}% ${asset.stableToken ? asset.stableToken.symbol : 'N/A'})`);
                return;
            }
            
            const confirmMessage = `Apply ratio ${ratio.native}% ${asset.nativeToken} / ${ratio.stable}% ${asset.stableToken ? asset.stableToken.symbol : 'N/A'} on ${asset.chainName}?\n\nActions needed:\n${actions.join('\n')}`;
            
            if (confirm(confirmMessage)) {
                // In a real implementation, this would execute trades
                alert(`Rebalancing ${asset.chainName} to target ratios...\n\nThis would execute: ${actions.join(', ')}`);
                
                // Clear modified badges
                const nativeInput = document.getElementById(`native-ratio-${chainId}`);
                const stableInput = document.getElementById(`stable-ratio-${chainId}`);
                if (nativeInput) nativeInput.classList.remove('modified');
                if (stableInput) stableInput.classList.remove('modified');
            }
        }

        function autoBalanceChainRatio(chainId) {
            const asset = allChainAssets.find(a => a.chainId === chainId);
            if (!asset) return;
            
            // Simple auto-balance: if chain has DEX, aim for 50/50, otherwise 100% native
            if (asset.hasDex && asset.stableToken) {
                chainAssetRatios[chainId] = { native: 50, stable: 50 };
            } else {
                chainAssetRatios[chainId] = { native: 100, stable: 0 };
            }
            
            updateRatioInputs(chainId);
            
            // Show notification
            const ratio = chainAssetRatios[chainId];
            alert(`Auto-balanced ${asset.chainName} ratios to ${ratio.native}% ${asset.nativeToken}, ${ratio.stable}% ${asset.stableToken ? asset.stableToken.symbol : 'N/A'}`);
        }

        function toggleChainRatioControls() {
            const controls = document.getElementById('chainRatioControls');
            if (controls.style.display === 'none') {
                controls.style.display = 'block';
                updateChainRatioControls();
            } else {
                controls.style.display = 'none';
            }
        }

        function updateChainRatioControls() {
            const container = document.getElementById('chainRatioControlsContent');
            
            if (allChainAssets.length === 0) {
                container.innerHTML = '<div class="alert alert-info">No assets found</div>';
                return;
            }
            
            let html = '<div class="row">';
            
            allChainAssets.forEach(asset => {
                const ratio = chainAssetRatios[asset.chainId] || { native: 50, stable: 50 };
                
                html += `
                    <div class="col-md-6 mb-3">
                        <div class="chain-ratio-controls">
                            <h6>${asset.chainName}</h6>
                            <div class="chain-ratio-inputs">
                                <label>${asset.nativeToken}:</label>
                                <input type="range" class="form-range chain-ratio-slider" 
                                       value="${ratio.native}" min="0" max="100"
                                       oninput="updateChainRatioFromSlider(${asset.chainId}, 'native', this.value)">
                                <input type="number" class="form-control chain-ratio-value" 
                                       value="${ratio.native}" min="0" max="100"
                                       onchange="updateChainRatio(${asset.chainId}, 'native', this.value)">
                                <span>%</span>
                            </div>
                `;
                
                if (asset.stableToken) {
                    html += `
                            <div class="chain-ratio-inputs">
                                <label>${asset.stableToken.symbol}:</label>
                                <input type="range" class="form-range chain-ratio-slider" 
                                       value="${ratio.stable}" min="0" max="100"
                                       oninput="updateChainRatioFromSlider(${asset.chainId}, 'stable', this.value)">
                                <input type="number" class="form-control chain-ratio-value" 
                                       value="${ratio.stable}" min="0" max="100"
                                       onchange="updateChainRatio(${asset.chainId}, 'stable', this.value)">
                                <span>%</span>
                            </div>
                    `;
                }
                
                html += `
                            <div class="ratio-summary">
                                <span>Target: ${ratio.native}% ${asset.nativeToken}, ${ratio.stable}% ${asset.stableToken ? asset.stableToken.symbol : 'N/A'}</span>
                                <button class="btn btn-sm btn-outline-primary" onclick="applyChainRatio(${asset.chainId})">
                                    Apply
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            container.innerHTML = html;
        }

        function applyChainAssetRatios() {
            // Apply all chain ratios
            let changes = [];
            
            allChainAssets.forEach(asset => {
                const ratio = chainAssetRatios[asset.chainId];
                if (ratio) {
                    changes.push(`${asset.chainName}: ${ratio.native}% ${asset.nativeToken}, ${ratio.stable}% ${asset.stableToken ? asset.stableToken.symbol : 'N/A'}`);
                }
            });
            
            if (changes.length === 0) {
                alert('No ratios to apply');
                return;
            }
            
            const confirmMessage = `Apply all chain ratios?\n\n${changes.join('\n')}`;
            
            if (confirm(confirmMessage)) {
                alert('Applying all chain ratios...\n\nIn a real implementation, this would execute trades on each chain to match target ratios.');
                
                // Clear all modified badges
                allChainAssets.forEach(asset => {
                    const nativeInput = document.getElementById(`native-ratio-${asset.chainId}`);
                    const stableInput = document.getElementById(`stable-ratio-${asset.chainId}`);
                    if (nativeInput) nativeInput.classList.remove('modified');
                    if (stableInput) stableInput.classList.remove('modified');
                });
            }
        }

        function resetChainAssetRatios() {
            if (!confirm('Reset all chain ratios to defaults?')) return;
            
            // Reset to defaults
            chainAssetRatios = {
                133: { native: 60, stable: 40 },
                10143: { native: 50, stable: 50 },
                1287: { native: 100, stable: 0 },
                11155111: { native: 100, stable: 0 }
            };
            
            // Update UI
            updateMultiChainAssetsDisplay();
            updateChainRatioControls();
            
            alert('Chain ratios reset to defaults');
        }

        // ========== Chain Trading Functions ==========
        async function showChainTradeModal(chainId, assetSymbol, action = 'buy') {
            const asset = allChainAssets.find(a => a.chainId === chainId);
            if (!asset) return;
            
            // Check if we're on the right chain
            if (currentChainId !== chainId) {
                alert(`Please switch to ${asset.chainName} first to trade`);
                return;
            }
            
            // Check if chain has DEX
            if (!asset.hasDex) {
                alert(`${asset.chainName} does not have DEX support`);
                return;
            }
            
            const modal = new bootstrap.Modal(document.getElementById('chainTradeModal'));
            const content = document.getElementById('chainTradeContent');
            
            const isNative = assetSymbol === asset.nativeToken;
            const isBuy = action === 'buy';
            const fromAsset = isBuy ? (isNative ? (asset.stableToken ? asset.stableToken.symbol : 'N/A') : asset.nativeToken) : assetSymbol;
            const toAsset = isBuy ? assetSymbol : (isNative ? (asset.stableToken ? asset.stableToken.symbol : 'N/A') : asset.nativeToken);
            
            // Get current balance
            let fromBalance = isNative ? asset.nativeAmount : asset.stableAmount;
            let toBalance = isNative ? asset.stableAmount : asset.nativeAmount;
            
            const exchangeRate = 1.05;
            
            let html = `
                <div class="trade-section">
                    <h6><i class="fas fa-exchange-alt me-2"></i>${action.toUpperCase()} ${assetSymbol} on ${asset.chainName}</h6>
                    
                    <div class="asset-selector">
                        <select class="form-select" id="trade-action-${chainId}" onchange="updateTradeForm(${chainId})">
                            <option value="buy" ${action === 'buy' ? 'selected' : ''}>Buy</option>
                            <option value="sell" ${action === 'sell' ? 'selected' : ''}>Sell</option>
                        </select>
                        <select class="form-select" id="trade-asset-${chainId}" onchange="updateTradeForm(${chainId})">
                            <option value="${asset.nativeToken}" ${assetSymbol === asset.nativeToken ? 'selected' : ''}>${asset.nativeToken}</option>
                            ${asset.stableToken ? `<option value="${asset.stableToken.symbol}" ${assetSymbol === asset.stableToken.symbol ? 'selected' : ''}>${asset.stableToken.symbol}</option>` : ''}
                        </select>
                    </div>
                    
                    <div class="amount-input">
                        <label>
                            <span>${isBuy ? 'Buy' : 'Sell'} Amount (${assetSymbol})</span>
                            <span class="balance">Balance: ${isBuy ? toBalance.toFixed(4) : fromBalance.toFixed(4)} ${assetSymbol}</span>
                        </label>
                        <input type="number" class="form-control" id="trade-amount-${chainId}" 
                               value="0.1" min="0.001" max="${isBuy ? toBalance : fromBalance}" step="0.001"
                               oninput="updateTradePreview(${chainId})">
                    </div>
                    
                    <div id="trade-preview-${chainId}" class="trade-preview">
                        <div class="trade-preview-item">
                            <span class="label">From:</span>
                            <span class="value">0 ${fromAsset}</span>
                        </div>
                        <div class="trade-preview-item">
                            <span class="label">To:</span>
                            <span class="value">0 ${toAsset}</span>
                        </div>
                        <div class="trade-preview-item">
                            <span class="label">Rate:</span>
                            <span class="value">1 ${fromAsset}  ${isBuy ? (isNative ? exchangeRate : 1/exchangeRate).toFixed(4) : (isNative ? (1/exchangeRate) : exchangeRate).toFixed(4)} ${toAsset}</span>
                        </div>
                        <div class="trade-preview-item">
                            <span class="label">Fee:</span>
                            <span class="value">0.3%</span>
                        </div>
                    </div>
                    
                    <div class="mt-3">
                        <button class="btn btn-primary w-100" onclick="executeChainTrade(${chainId})">
                            <i class="fas fa-check me-2"></i>Confirm ${isBuy ? 'Buy' : 'Sell'}
                        </button>
                    </div>
                </div>
                
                <div class="trade-section mt-3">
                    <h6><i class="fas fa-history me-2"></i>Recent Trades</h6>
                    <div class="small text-muted">
                        <div class="d-flex justify-content-between mb-1">
                            <span>Buy 0.5 ${asset.nativeToken} at 1.05 ${asset.stableToken ? asset.stableToken.symbol : 'USD'}</span>
                            <span>2 min ago</span>
                        </div>
                        <div class="d-flex justify-content-between mb-1">
                            <span>Sell 0.3 ${asset.nativeToken} at 0.95 ${asset.stableToken ? asset.stableToken.symbol : 'USD'}</span>
                            <span>15 min ago</span>
                        </div>
                        <div class="d-flex justify-content-between">
                            <span>Buy 1.2 ${asset.nativeToken} at 1.04 ${asset.stableToken ? asset.stableToken.symbol : 'USD'}</span>
                            <span>1 hour ago</span>
                        </div>
                    </div>
                </div>
            `;
            
            content.innerHTML = html;
            modal.show();
            
            // Initial preview update
            updateTradePreview(chainId);
        }

        function updateTradeForm(chainId) {
            const action = document.getElementById(`trade-action-${chainId}`).value;
            const asset = document.getElementById(`trade-asset-${chainId}`).value;
            
            // Close current modal and open new one
            bootstrap.Modal.getInstance(document.getElementById('chainTradeModal')).hide();
            setTimeout(() => {
                showChainTradeModal(chainId, asset, action);
            }, 300);
        }

        function updateTradePreview(chainId) {
            const asset = allChainAssets.find(a => a.chainId === chainId);
            if (!asset) return;
            
            const action = document.getElementById(`trade-action-${chainId}`).value;
            const assetSymbol = document.getElementById(`trade-asset-${chainId}`).value;
            const amount = parseFloat(document.getElementById(`trade-amount-${chainId}`).value) || 0;
            
            const isNative = assetSymbol === asset.nativeToken;
            const isBuy = action === 'buy';
            const fromAsset = isBuy ? (isNative ? (asset.stableToken ? asset.stableToken.symbol : 'N/A') : asset.nativeToken) : assetSymbol;
            const toAsset = isBuy ? assetSymbol : (isNative ? (asset.stableToken ? asset.stableToken.symbol : 'N/A') : asset.nativeToken);
            
            const exchangeRate = 1.05;
            
            let fromAmount, toAmount;
            
            if (isNative) {
                // Trading native token
                if (isBuy) {
                    // Buying native: pay stable
                    fromAmount = amount * exchangeRate;
                    toAmount = amount;
                } else {
                    // Selling native: receive stable
                    fromAmount = amount;
                    toAmount = amount * (1/exchangeRate);
                }
            } else {
                // Trading stable token
                if (isBuy) {
                    // Buying stable: pay native
                    fromAmount = amount / exchangeRate;
                    toAmount = amount;
                } else {
                    // Selling stable: receive native
                    fromAmount = amount;
                    toAmount = amount * exchangeRate;
                }
            }
            
            const fee = fromAmount * 0.003; // 0.3% fee
            
            const preview = document.getElementById(`trade-preview-${chainId}`);
            if (preview) {
                preview.innerHTML = `
                    <div class="trade-preview-item">
                        <span class="label">From:</span>
                        <span class="value">${fromAmount.toFixed(4)} ${fromAsset}</span>
                    </div>
                    <div class="trade-preview-item">
                        <span class="label">To:</span>
                        <span class="value">${toAmount.toFixed(4)} ${toAsset}</span>
                    </div>
                    <div class="trade-preview-item">
                        <span class="label">Rate:</span>
                        <span class="value">1 ${fromAsset}  ${(toAmount/fromAmount).toFixed(4)} ${toAsset}</span>
                    </div>
                    <div class="trade-preview-item">
                        <span class="label">Fee:</span>
                        <span class="value">${fee.toFixed(4)} ${fromAsset}</span>
                    </div>
                    <div class="trade-preview-item" style="border-top: 1px solid var(--border); padding-top: 8px; margin-top: 8px;">
                        <span class="label">Total ${isBuy ? 'Cost' : 'Receive'}:</span>
                        <span class="value">${isBuy ? (fromAmount + fee).toFixed(4) : (toAmount - fee).toFixed(4)} ${isBuy ? fromAsset : toAsset}</span>
                    </div>
                `;
            }
        }

        async function executeChainTrade(chainId) {
            const asset = allChainAssets.find(a => a.chainId === chainId);
            if (!asset) return;
            
            const action = document.getElementById(`trade-action-${chainId}`).value;
            const assetSymbol = document.getElementById(`trade-asset-${chainId}`).value;
            const amount = parseFloat(document.getElementById(`trade-amount-${chainId}`).value) || 0;
            
            if (amount <= 0) {
                alert('Please enter a valid amount');
                return;
            }
            
            // Check balance
            const isNative = assetSymbol === asset.nativeToken;
            const isBuy = action === 'buy';
            
            // Calculate exchange rate and fee
            const exchangeRate = 1.05;
            
            let cost, fee, totalCost, balanceNeeded;
            
            if (isNative) {
                if (isBuy) {
                    // Buying native token
                    cost = amount * exchangeRate;
                    fee = cost * 0.003;
                    totalCost = cost + fee;
                    balanceNeeded = asset.stableAmount;
                    
                    if (totalCost > balanceNeeded) {
                        alert(`Insufficient ${asset.stableToken ? asset.stableToken.symbol : 'stable'} balance. Needed: ${totalCost.toFixed(4)}, Available: ${balanceNeeded.toFixed(4)}`);
                        return;
                    }
                } else {
                    // Selling native token
                    if (amount > asset.nativeAmount) {
                        alert(`Insufficient ${asset.nativeToken} balance. Needed: ${amount.toFixed(4)}, Available: ${asset.nativeAmount.toFixed(4)}`);
                        return;
                    }
                    cost = amount / exchangeRate;
                    fee = cost * 0.003;
                    totalCost = cost - fee;
                }
            } else {
                if (isBuy) {
                    // Buying stable token
                    cost = amount / exchangeRate;
                    fee = cost * 0.003;
                    totalCost = cost + fee;
                    balanceNeeded = asset.nativeAmount;
                    
                    if (totalCost > balanceNeeded) {
                        alert(`Insufficient ${asset.nativeToken} balance. Needed: ${totalCost.toFixed(4)}, Available: ${balanceNeeded.toFixed(4)}`);
                        return;
                    }
                } else {
                    // Selling stable token
                    if (amount > asset.stableAmount) {
                        alert(`Insufficient ${asset.stableToken.symbol} balance. Needed: ${amount.toFixed(4)}, Available: ${asset.stableAmount.toFixed(4)}`);
                        return;
                    }
                    cost = amount * exchangeRate;
                    fee = cost * 0.003;
                    totalCost = cost - fee;
                }
            }
            
            const confirmMessage = `Confirm ${action}?\n\n${isBuy ? 'Buy' : 'Sell'} ${amount.toFixed(4)} ${assetSymbol}\nRate: 1 ${isNative ? asset.nativeToken : (asset.stableToken ? asset.stableToken.symbol : 'USD')}  ${(isBuy ? (isNative ? exchangeRate : 1/exchangeRate) : (isNative ? 1/exchangeRate : exchangeRate)).toFixed(4)} ${isNative ? (asset.stableToken ? asset.stableToken.symbol : 'USD') : asset.nativeToken}\nFee: ${fee.toFixed(4)} ${isBuy ? (isNative ? (asset.stableToken ? asset.stableToken.symbol : 'USD') : asset.nativeToken) : (isNative ? (asset.stableToken ? asset.stableToken.symbol : 'USD') : asset.nativeToken)}\nTotal: ${isBuy ? (totalCost).toFixed(4) : (totalCost).toFixed(4)} ${isBuy ? (isNative ? (asset.stableToken ? asset.stableToken.symbol : 'USD') : asset.nativeToken) : (isNative ? (asset.stableToken ? asset.stableToken.symbol : 'USD') : asset.nativeToken)}`;
            
            if (!confirm(confirmMessage)) return;
            
            try {
                // Show transaction status
                const statusDiv = document.getElementById('chainTradeStatus');
                statusDiv.innerHTML = `
                    <div class="transaction-status">
                        <div class="transaction-step pending">
                            <i class="fas fa-spinner fa-spin"></i>
                            <span>Preparing transaction...</span>
                        </div>
                        <div class="transaction-step">
                            <i class="fas fa-file-signature"></i>
                            <span>Waiting for wallet signature...</span>
                        </div>
                        <div class="transaction-step">
                            <i class="fas fa-sync-alt"></i>
                            <span>Executing trade on DEX...</span>
                        </div>
                        <div class="transaction-step">
                            <i class="fas fa-check-circle"></i>
                            <span>Updating balances...</span>
                        </div>
                    </div>
                `;
                
                // Get DEX contract
                const chain = CHAINS[chainId];
                const dexContract = new ethers.Contract(chain.dex, TINYDEX_ABI, signer);
                
                if (isNative) {
                    if (isBuy) {
                        // Buying native token with stable token
                        // First approve DEX to spend stable tokens
                        const tokenContract = new ethers.Contract(
                            chain.stableToken.address,
                            TOKEN_ABI,
                            signer
                        );
                        
                        const approveTx = await tokenContract.approve(
                            chain.dex,
                            ethers.utils.parseEther(totalCost.toString())
                        );
                        await approveTx.wait();
                        
                        // Execute sellToken (selling stable to get native)
                        const tx = await dexContract.sellToken(
                            chain.stableToken.address,
                            ethers.utils.parseEther(totalCost.toString())
                        );
                        await tx.wait();
                        
                    } else {
                        // Selling native token for stable token
                        // Execute buyToken (buying stable with native)
                        const tx = await dexContract.buyToken(
                            chain.stableToken.address,
                            { value: ethers.utils.parseEther(amount.toString()) }
                        );
                        await tx.wait();
                    }
                } else {
                    if (isBuy) {
                        // Buying stable token with native token
                        const tx = await dexContract.buyToken(
                            chain.stableToken.address,
                            { value: ethers.utils.parseEther(totalCost.toString()) }
                        );
                        await tx.wait();
                    } else {
                        // Selling stable token for native token
                        // First approve DEX to spend stable tokens
                        const tokenContract = new ethers.Contract(
                            chain.stableToken.address,
                            TOKEN_ABI,
                            signer
                        );
                        
                        const approveTx = await tokenContract.approve(
                            chain.dex,
                            ethers.utils.parseEther(amount.toString())
                        );
                        await approveTx.wait();
                        
                        // Execute sellToken
                        const tx = await dexContract.sellToken(
                            chain.stableToken.address,
                            ethers.utils.parseEther(amount.toString())
                        );
                        await tx.wait();
                    }
                }
                
                // Update transaction status
                statusDiv.innerHTML = `
                    <div class="transaction-status">
                        <div class="transaction-step completed">
                            <i class="fas fa-check-circle"></i>
                            <span>Transaction prepared</span>
                        </div>
                        <div class="transaction-step completed">
                            <i class="fas fa-check-circle"></i>
                            <span>Wallet signature confirmed</span>
                        </div>
                        <div class="transaction-step completed">
                            <i class="fas fa-check-circle"></i>
                            <span>Trade executed on DEX</span>
                        </div>
                        <div class="transaction-step pending">
                            <i class="fas fa-spinner fa-spin"></i>
                            <span>Updating balances...</span>
                        </div>
                    </div>
                `;
                
                // Reload assets to get updated balances
                await loadMultiChainAssets();
                
                // Update status
                statusDiv.innerHTML = `
                    <div class="alert alert-success">
                        <i class="fas fa-check-circle me-2"></i>
                        Trade executed successfully! ${isBuy ? 'Bought' : 'Sold'} ${amount.toFixed(4)} ${assetSymbol} on ${asset.chainName}
                    </div>
                `;
                
                // Close modal after 3 seconds
                setTimeout(() => {
                    bootstrap.Modal.getInstance(document.getElementById('chainTradeModal')).hide();
                    statusDiv.innerHTML = '';
                }, 3000);
                
            } catch (error) {
                console.error('Trade execution failed:', error);
                document.getElementById('chainTradeStatus').innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-times-circle me-2"></i>
                        Trade failed: ${error.message}
                    </div>
                `;
            }
        }

        function rebalanceChainAssets(chainId) {
            const asset = allChainAssets.find(a => a.chainId === chainId);
            if (!asset) return;
            
            const ratio = chainAssetRatios[chainId];
            if (!ratio) return;
            
            // Calculate rebalancing needs
            const totalValue = asset.chainValue;
            const targetNative = (ratio.native / 100) * totalValue;
            const targetStable = (ratio.stable / 100) * totalValue;
            const currentNative = asset.nativeAmount;
            const currentStable = asset.stableBalance;
            
            let trades = [];
            
            // Check if native needs adjustment
            if (Math.abs(currentNative - targetNative) > 0.001) {
                if (currentNative < targetNative) {
                    const buyAmount = targetNative - currentNative;
                    trades.push(`Buy ${buyAmount.toFixed(4)} ${asset.nativeToken}`);
                } else {
                    const sellAmount = currentNative - targetNative;
                    trades.push(`Sell ${sellAmount.toFixed(4)} ${asset.nativeToken}`);
                }
            }
            
            // Check if stable needs adjustment (if stable token exists)
            if (asset.stableToken && Math.abs(currentStable - targetStable) > 0.001) {
                if (currentStable < targetStable) {
                    const buyAmount = targetStable - currentStable;
                    trades.push(`Buy ${buyAmount.toFixed(4)} ${asset.stableToken.symbol}`);
                } else {
                    const sellAmount = currentStable - targetStable;
                    trades.push(`Sell ${sellAmount.toFixed(4)} ${asset.stableToken.symbol}`);
                }
            }
            
            if (trades.length === 0) {
                alert(`Portfolio on ${asset.chainName} already matches target ratios`);
                return;
            }
            
            const confirmMessage = `Rebalance ${asset.chainName} to ${ratio.native}% ${asset.nativeToken}, ${ratio.stable}% ${asset.stableToken ? asset.stableToken.symbol : 'N/A'}?\n\nTrades needed:\n${trades.join('\n')}`;
            
            if (confirm(confirmMessage)) {
                // Execute rebalancing through DEX
                alert(`Rebalancing ${asset.chainName}...\n\nExecuting trades: ${trades.join(', ')}`);
                
                // Refresh assets
                setTimeout(() => {
                    loadMultiChainAssets();
                }, 1000);
            }
        }

        // ========== Cross-Chain Allocation Management ==========
        function updateCrossChainAllocationDisplay() {
            const container = document.getElementById('crossChainAllocation');
            
            if (allChainAssets.length === 0) {
                container.innerHTML = `
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        No assets to allocate
                    </div>
                `;
                return;
            }
            
            // Calculate current allocation
            let totalValue = 0;
            let currentAllocation = {};
            
            allChainAssets.forEach(asset => {
                totalValue += asset.chainValue;
                currentAllocation[asset.chainId] = {
                    name: asset.chainName,
                    value: asset.chainValue,
                    percent: 0
                };
            });
            
            // Calculate percentages
            Object.keys(currentAllocation).forEach(chainId => {
                currentAllocation[chainId].percent = totalValue > 0 ? 
                    (currentAllocation[chainId].value / totalValue * 100).toFixed(1) : 0;
            });
            
            // Create allocation UI
            let html = '<div class="allocation-progress">';
            let allocationItems = '';
            
            // Sort by value descending
            const sortedAllocation = Object.entries(currentAllocation)
                .sort((a, b) => b[1].value - a[1].value);
            
            sortedAllocation.forEach(([chainId, data]) => {
                const chain = CHAINS[chainId];
                if (chain && data.percent > 0) {
                    html += `<div class="allocation-progress-bar" style="width: ${data.percent}%; background-color: ${chain.color}"></div>`;
                    
                    allocationItems += `
                        <div class="allocation-item">
                            <div>
                                <span class="chain-badge ${getChainBadgeClass(parseInt(chainId))}">${data.name}</span>
                                <span class="ms-2 small text-muted">${data.value.toFixed(4)}</span>
                            </div>
                            <div class="fw-bold">${data.percent}%</div>
                        </div>
                    `;
                }
            });
            
            html += '</div>';
            
            container.innerHTML = html + allocationItems;
            
            // Update allocation inputs if needed
            updateCrossChainAllocationInputs();
        }

        function updateCrossChainAllocationInputs() {
            const container = document.getElementById('crossChainAllocationConfig');
            const strategyType = document.getElementById('strategyType').value;
            
            if (strategyType === 'cross_chain') {
                let html = '<h6 class="mb-3">Cross-Chain Allocation</h6>';
                
                allChainAssets.forEach(asset => {
                    const currentPercent = crossChainAllocation[asset.chainId] || 0;
                    html += `
                        <div class="percentage-control mb-3">
                            <label class="form-label">${asset.chainName}</label>
                            <div class="slider-container">
                                <input type="range" class="form-range" 
                                       id="allocation-${asset.chainId}" 
                                       min="0" max="100" value="${currentPercent}"
                                       oninput="updateAllocationValue(${asset.chainId}, this.value)">
                            </div>
                            <div class="input-container">
                                <input type="number" class="form-control" 
                                       id="allocation-input-${asset.chainId}" 
                                       value="${currentPercent}" min="0" max="100"
                                       oninput="updateAllocationValue(${asset.chainId}, this.value, 'input')">
                            </div>
                            <span>%</span>
                        </div>
                    `;
                });
                
                html += `
                    <div class="mt-3 text-center">
                        <small class="text-muted">Total Allocation: <span id="totalAllocationPercent">0</span>%</small>
                        <div id="allocationWarning" class="small text-danger mt-1" style="display: none;">
                            Total allocation must be 100%
                        </div>
                    </div>
                `;
                
                container.innerHTML = html;
                updateTotalAllocation();
            } else if (strategyType === 'asset_type') {
                container.innerHTML = `
                    <h6 class="mb-3">Asset Type Allocation</h6>
                    <div class="percentage-control mb-3">
                        <label class="form-label">Native Tokens</label>
                        <div class="slider-container">
                            <input type="range" class="form-range" 
                                   id="allocation-native" 
                                   min="0" max="100" value="60"
                                   oninput="updateAssetTypeAllocation('native', this.value)">
                        </div>
                        <div class="input-container">
                            <input type="number" class="form-control" 
                                   id="allocation-input-native" 
                                   value="60" min="0" max="100"
                                   oninput="updateAssetTypeAllocation('native', this.value, 'input')">
                        </div>
                        <span>%</span>
                    </div>
                    <div class="percentage-control mb-3">
                        <label class="form-label">Stablecoins</label>
                        <div class="slider-container">
                            <input type="range" class="form-range" 
                                   id="allocation-stable" 
                                   min="0" max="100" value="40"
                                   oninput="updateAssetTypeAllocation('stable', this.value)">
                        </div>
                        <div class="input-container">
                            <input type="number" class="form-control" 
                                   id="allocation-input-stable" 
                                   value="40" min="0" max="100"
                                   oninput="updateAssetTypeAllocation('stable', this.value, 'input')">
                        </div>
                        <span>%</span>
                    </div>
                `;
            } else if (strategyType === 'chain_specific') {
                container.innerHTML = `
                    <h6 class="mb-3">Chain-Specific Configuration</h6>
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        Configure individual chain asset ratios below
                    </div>
                    <div id="chainSpecificConfig">
                        <!-- Chain-specific configuration will be loaded here -->
                    </div>
                `;
                
                // Load chain-specific configuration
                let chainConfigHtml = '';
                allChainAssets.forEach(asset => {
                    const ratio = chainAssetRatios[asset.chainId] || { native: 50, stable: 50 };
                    chainConfigHtml += `
                        <div class="chain-ratio-controls mb-3">
                            <h6>${asset.chainName}</h6>
                            <div class="chain-ratio-inputs">
                                <label>${asset.nativeToken}:</label>
                                <input type="range" class="form-range chain-ratio-slider" 
                                       value="${ratio.native}" min="0" max="100"
                                       oninput="updateChainRatioFromSlider(${asset.chainId}, 'native', this.value)">
                                <input type="number" class="form-control chain-ratio-value" 
                                       value="${ratio.native}" min="0" max="100"
                                       onchange="updateChainRatio(${asset.chainId}, 'native', this.value)">
                                <span>%</span>
                            </div>
                    `;
                    
                    if (asset.stableToken) {
                        chainConfigHtml += `
                            <div class="chain-ratio-inputs">
                                <label>${asset.stableToken.symbol}:</label>
                                <input type="range" class="form-range chain-ratio-slider" 
                                       value="${ratio.stable}" min="0" max="100"
                                       oninput="updateChainRatioFromSlider(${asset.chainId}, 'stable', this.value)">
                                <input type="number" class="form-control chain-ratio-value" 
                                       value="${ratio.stable}" min="0" max="100"
                                       onchange="updateChainRatio(${asset.chainId}, 'stable', this.value)">
                                <span>%</span>
                            </div>
                        `;
                    }
                    
                    chainConfigHtml += `
                            <div class="ratio-summary">
                                <span>${ratio.native}% ${asset.nativeToken}, ${ratio.stable}% ${asset.stableToken ? asset.stableToken.symbol : 'N/A'}</span>
                            </div>
                        </div>
                    `;
                });
                
                document.getElementById('chainSpecificConfig').innerHTML = chainConfigHtml;
            } else if (strategyType === 'risk_based') {
                container.innerHTML = `
                    <h6 class="mb-3">Risk-Based Allocation</h6>
                    <div class="mb-3">
                        <label class="form-label">Risk Level</label>
                        <select class="form-control" id="riskLevel">
                            <option value="low">Low Risk (Conservative)</option>
                            <option value="medium" selected>Medium Risk (Balanced)</option>
                            <option value="high">High Risk (Aggressive)</option>
                        </select>
                    </div>
                    <div id="riskAllocationPreview" class="alert alert-info">
                        Select risk level to see allocation
                    </div>
                `;
                
                // Add event listener for risk level change
                document.getElementById('riskLevel').addEventListener('change', updateRiskBasedAllocation);
                updateRiskBasedAllocation();
            } else {
                container.innerHTML = `
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        Manual configuration allows you to set specific targets for each chain
                    </div>
                `;
            }
            
            // Show strategy action panel
            document.getElementById('crossChainStrategyActionPanel').style.display = 'block';
        }

        function updateRiskBasedAllocation() {
            const riskLevel = document.getElementById('riskLevel').value;
            const preview = document.getElementById('riskAllocationPreview');
            
            let allocation = {};
            let description = '';
            
            switch(riskLevel) {
                case 'low':
                    allocation = { native_tokens: 30, stablecoins: 60, defi_tokens: 10 };
                    description = 'Conservative allocation favoring stablecoins and established chains';
                    break;
                case 'medium':
                    allocation = { native_tokens: 50, stablecoins: 30, defi_tokens: 20 };
                    description = 'Balanced allocation with moderate exposure to growth assets';
                    break;
                case 'high':
                    allocation = { native_tokens: 70, stablecoins: 10, defi_tokens: 20 };
                    description = 'Aggressive allocation focusing on high-growth native tokens';
                    break;
            }
            
            preview.innerHTML = `
                <strong>${riskLevel.charAt(0).toUpperCase() + riskLevel.slice(1)} Risk Allocation:</strong><br>
                Native Tokens: ${allocation.native_tokens}%<br>
                Stablecoins: ${allocation.stablecoins}%<br>
                DeFi Tokens: ${allocation.defi_tokens}%<br><br>
                <small>${description}</small>
            `;
        }

        function updateAllocationValue(chainId, value, type = 'slider') {
            // Update corresponding input
            if (type === 'slider') {
                document.getElementById(`allocation-input-${chainId}`).value = value;
            } else {
                document.getElementById(`allocation-${chainId}`).value = value;
            }
            
            // Update allocation object
            crossChainAllocation[chainId] = parseInt(value) || 0;
            
            // Update total
            updateTotalAllocation();
        }

        function updateAssetTypeAllocation(type, value, inputType = 'slider') {
            // Update corresponding input
            if (inputType === 'slider') {
                document.getElementById(`allocation-input-${type}`).value = value;
            } else {
                document.getElementById(`allocation-${type}`).value = value;
            }
            
            // Auto-balance the other type
            const otherType = type === 'native' ? 'stable' : 'native';
            const otherValue = 100 - parseInt(value);
            
            document.getElementById(`allocation-input-${otherType}`).value = otherValue;
            document.getElementById(`allocation-${otherType}`).value = otherValue;
        }

        function updateTotalAllocation() {
            let total = 0;
            allChainAssets.forEach(asset => {
                total += crossChainAllocation[asset.chainId] || 0;
            });
            
            document.getElementById('totalAllocationPercent').textContent = total;
            
            // Update warning
            const warning = document.getElementById('allocationWarning');
            if (total !== 100) {
                warning.style.display = 'block';
                warning.textContent = `Total allocation must be 100% (current: ${total}%)`;
            } else {
                warning.style.display = 'none';
            }
        }

        function autoBalanceCrossChain() {
            // Simple auto-balance: distribute equally among chains with assets
            const chainCount = allChainAssets.length;
            if (chainCount === 0) return;
            
            const equalPercent = Math.floor(100 / chainCount);
            let remainder = 100 - (equalPercent * chainCount);
            
            allChainAssets.forEach((asset, index) => {
                let percent = equalPercent;
                if (index === 0) {
                    percent += remainder; // Add remainder to first chain
                }
                
                crossChainAllocation[asset.chainId] = percent;
                
                // Update UI
                const allocationInput = document.getElementById(`allocation-${asset.chainId}`);
                const allocationInputValue = document.getElementById(`allocation-input-${asset.chainId}`);
                if (allocationInput) allocationInput.value = percent;
                if (allocationInputValue) allocationInputValue.value = percent;
            });
            
            updateTotalAllocation();
        }

        function resetCrossChainAllocation() {
            allChainAssets.forEach(asset => {
                crossChainAllocation[asset.chainId] = 0;
                
                // Update UI
                const allocationInput = document.getElementById(`allocation-${asset.chainId}`);
                const allocationInputValue = document.getElementById(`allocation-input-${asset.chainId}`);
                if (allocationInput) allocationInput.value = 0;
                if (allocationInputValue) allocationInputValue.value = 0;
            });
            
            updateTotalAllocation();
        }

        function applyCrossChainAllocation() {
            const total = Object.values(crossChainAllocation).reduce((sum, val) => sum + (val || 0), 0);
            
            if (total !== 100) {
                alert(`Total allocation must be 100%, current is ${total}%. Please adjust the allocations.`);
                return;
            }
            
            alert('Cross-chain allocation applied successfully!');
            
            // Calculate and show rebalancing plan
            calculateCrossChainRebalance();
        }

        function calculateCrossChainRebalance() {
            // This is a simplified version - in reality, this would involve complex cross-chain calculations
            const resultDiv = document.getElementById('crossChainResult');
            
            let rebalancePlan = '<div class="alert alert-info"><h6>Cross-Chain Rebalancing Plan</h6>';
            
            allChainAssets.forEach(asset => {
                const targetPercent = crossChainAllocation[asset.chainId] || 0;
                if (targetPercent > 0) {
                    rebalancePlan += `<p>${asset.chainName}: Target ${targetPercent}% allocation</p>`;
                }
            });
            
            rebalancePlan += '<p class="mt-2"><strong>Note:</strong> Full cross-chain rebalancing requires bridge operations between chains.</p>';
            rebalancePlan += '</div>';
            
            resultDiv.innerHTML = rebalancePlan;
        }

        function executeCrossChainRebalance() {
            if (!userAddress) {
                alert('Please connect your wallet first');
                return;
            }
            
            const total = Object.values(crossChainAllocation).reduce((sum, val) => sum + (val || 0), 0);
            
            if (total !== 100) {
                alert(`Total allocation must be 100%, current is ${total}%. Please adjust the allocations.`);
                return;
            }
            
            // This is a simplified simulation
            alert('Cross-chain rebalancing would involve complex bridge operations between chains. In a real implementation, this would execute transactions across multiple chains.');
        }

        // ========== UI Update Functions ==========
        function updateCrossChainOverview() {
            const container = document.getElementById('crossChainOverview');
            
            if (allChainAssets.length === 0) {
                container.innerHTML = `
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        No assets found across chains
                    </div>
                `;
                return;
            }
            
            // Calculate totals
            let totalValue = 0;
            let nativeTotal = 0;
            let stableTotal = 0;
            let chainCount = allChainAssets.length;
            
            allChainAssets.forEach(asset => {
                totalValue += asset.chainValue;
                nativeTotal += asset.nativeAmount;
                stableTotal += asset.stableBalance;
            });
            
            const nativePercent = totalValue > 0 ? (nativeTotal / totalValue * 100).toFixed(1) : 0;
            const stablePercent = totalValue > 0 ? (stableTotal / totalValue * 100).toFixed(1) : 0;
            
            // Create progress bars for each chain
            let chainProgress = '';
            allChainAssets.forEach(asset => {
                const chainPercent = totalValue > 0 ? (asset.chainValue / totalValue * 100).toFixed(1) : 0;
                chainProgress += `
                    <div class="mb-2">
                        <div class="d-flex justify-content-between small">
                            <span>${asset.chainName}</span>
                            <span>${chainPercent}% (${asset.chainValue.toFixed(4)})</span>
                        </div>
                        <div class="progress" style="height: 6px;">
                            <div class="progress-bar" style="width: ${chainPercent}%; background-color: ${asset.color}"></div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = `
                <div class="row">
                    <div class="col-md-6">
                        <div class="stats-card">
                            <div class="d-flex justify-content-between align-items-center">
                                <span>Total Cross-Chain Value</span>
                                <span class="fw-bold h5">${totalValue.toFixed(4)}</span>
                            </div>
                        </div>
                        <div class="stats-card">
                            <div class="d-flex justify-content-between align-items-center">
                                <span>Native Tokens</span>
                                <span class="fw-bold">${nativeTotal.toFixed(4)} (${nativePercent}%)</span>
                            </div>
                        </div>
                        <div class="stats-card">
                            <div class="d-flex justify-content-between align-items-center">
                                <span>Stablecoins</span>
                                <span class="fw-bold">${stableTotal.toFixed(4)} (${stablePercent}%)</span>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="stats-card">
                            <div class="d-flex justify-content-between align-items-center">
                                <span>Chains with Assets</span>
                                <span class="fw-bold">${chainCount}</span>
                            </div>
                        </div>
                        <div class="stats-card">
                            <div class="d-flex justify-content-between align-items-center">
                                <span>Average per Chain</span>
                                <span class="fw-bold">${chainCount > 0 ? (totalValue / chainCount).toFixed(4) : 0}</span>
                            </div>
                        </div>
                        <div class="stats-card">
                            <div class="d-flex justify-content-between align-items-center">
                                <span>Max Chain Value</span>
                                <span class="fw-bold">${allChainAssets.length > 0 ? Math.max(...allChainAssets.map(a => a.chainValue)).toFixed(4) : 0}</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="mt-4">
                    <h6><i class="fas fa-chart-line me-2"></i>Chain Distribution</h6>
                    ${chainProgress}
                </div>
            `;
        }

        function updatePortfolioSummary(totalValue = 0) {
            if (totalValue === 0) {
                // Calculate total value
                allChainAssets.forEach(asset => {
                    totalValue += asset.chainValue;
                });
            }
            
            document.getElementById('totalPortfolioValue').textContent = totalValue.toFixed(4);
            document.getElementById('chainCount').textContent = allChainAssets.length;
            
            // Count total assets (native + stable per chain)
            let assetCount = 0;
            allChainAssets.forEach(asset => {
                assetCount++; // Native token always exists
                if (asset.stableToken && asset.stableAmount > 0) {
                    assetCount++;
                }
            });
            
            document.getElementById('assetCount').textContent = assetCount;
            document.getElementById('avgPerChain').textContent = allChainAssets.length > 0 ? (totalValue / allChainAssets.length).toFixed(4) : '0.00';
        }

        function updateAssetDistributionChart() {
            const container = document.getElementById('assetDistributionChart');
            
            if (allChainAssets.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-4">
                        <i class="fas fa-chart-pie fa-3x text-muted mb-3"></i>
                        <p class="text-muted">No asset data available</p>
                    </div>
                `;
                return;
            }
            
            // Calculate distribution by chain
            let totalValue = 0;
            allChainAssets.forEach(asset => {
                totalValue += asset.chainValue;
            });
            
            let distributionHTML = '<div class="allocation-progress">';
            let legendHTML = '<div class="mt-3">';
            
            allChainAssets.forEach(asset => {
                const percent = totalValue > 0 ? (asset.chainValue / totalValue * 100).toFixed(1) : 0;
                if (percent > 0) {
                    distributionHTML += `
                        <div class="allocation-progress-bar" style="width: ${percent}%; background-color: ${asset.color}"></div>
                    `;
                    
                    legendHTML += `
                        <div class="d-flex align-items-center mb-2">
                            <div style="width: 12px; height: 12px; background-color: ${asset.color}; border-radius: 2px; margin-right: 8px;"></div>
                            <span class="small">${asset.chainName}: ${percent}%</span>
                        </div>
                    `;
                }
            });
            
            distributionHTML += '</div>';
            legendHTML += '</div>';
            
            container.innerHTML = distributionHTML + legendHTML;
        }

        function updateCrossChainHoldings() {
            const container = document.getElementById('crossChainHoldings');
            
            if (allChainAssets.length === 0) {
                container.innerHTML = `
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        No cross-chain holdings found
                    </div>
                `;
                return;
            }
            
            let html = '';
            let totalValue = 0;
            
            allChainAssets.forEach(asset => {
                totalValue += asset.chainValue;
                const percent = totalValue > 0 ? (asset.chainValue / totalValue * 100).toFixed(1) : 0;
                
                html += `
                    <div class="strategy-item">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <span class="chain-badge ${getChainBadgeClass(asset.chainId)} me-2">${asset.chainName}</span>
                                <span class="text-muted small">
                                    ${asset.nativeToken}${asset.stableToken ? ` + ${asset.stableToken.symbol}` : ''}
                                </span>
                            </div>
                            <div class="text-end">
                                <div class="fw-bold">${asset.chainValue.toFixed(4)}</div>
                                <small class="text-muted">${percent}%</small>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            html += `
                <div class="mt-3 p-2 bg-dark rounded">
                    <div class="d-flex justify-content-between">
                        <span>Total Cross-Chain Value:</span>
                        <span class="fw-bold">${totalValue.toFixed(4)}</span>
                    </div>
                </div>
            `;
            
            container.innerHTML = html;
        }

        // ========== Multi-Chain NFT Marketplace ==========
        async function loadAllChainNFTs() {
            try {
                const marketplace = document.getElementById('marketplace');
                marketplace.innerHTML = `
                    <div class="marketplace-loading">
                        <span class="loading"></span>
                        <p class="text-muted">Loading multi-chain marketplace data...</p>
                    </div>
                `;
                
                if (!userAddress) {
                    marketplace.innerHTML = `
                        <div class="col-12">
                            <div class="alert alert-warning">
                                <i class="fas fa-exclamation-triangle me-2"></i>
                                Please connect your wallet first
                            </div>
                        </div>
                    `;
                    return;
                }
                
                allChainNFTs = [];
                let hashkeyNFTs = 0;
                let monadNFTs = 0;
                let crossChainNFTs = 0;
                
                // Load NFTs from HashKey Chain (Chain ID: 133)
                try {
                    const hashkeyNFTsData = await loadChainNFTs(133);
                    hashkeyNFTs = hashkeyNFTsData.length;
                    allChainNFTs = allChainNFTs.concat(hashkeyNFTsData.map(nft => ({ ...nft, chainId: 133 })));
                } catch (error) {
                    console.error('Failed to load HashKey Chain NFTs:', error);
                }
                
                // Load NFTs from Monad Testnet (Chain ID: 10143)
                try {
                    const monadNFTsData = await loadChainNFTs(10143);
                    monadNFTs = monadNFTsData.length;
                    allChainNFTs = allChainNFTs.concat(monadNFTsData.map(nft => ({ ...nft, chainId: 10143 })));
                } catch (error) {
                    console.error('Failed to load Monad Testnet NFTs:', error);
                }
                
                // Update statistics
                document.getElementById('totalNFTCount').textContent = allChainNFTs.length;
                document.getElementById('hashkeyNFTCount').textContent = hashkeyNFTs;
                document.getElementById('monadNFTCount').textContent = monadNFTs;
                document.getElementById('crossChainNFTCount').textContent = allChainNFTs.filter(nft => 
                    nft.name && nft.name.toLowerCase().includes('cross-chain')
                ).length;
                
                if (allChainNFTs.length === 0) {
                    marketplace.innerHTML = `
                        <div class="col-12">
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle me-2"></i>
                                No NFT strategies found in the marketplace yet. Be the first to mint one!
                            </div>
                        </div>
                    `;
                    return;
                }
                
                // Display all NFTs
                displayAllChainNFTs(allChainNFTs);
                
            } catch (error) {
                console.error('Failed to load marketplace:', error);
                const marketplace = document.getElementById('marketplace');
                marketplace.innerHTML = `
                    <div class="col-12">
                        <div class="alert alert-danger">
                            <i class="fas fa-times-circle me-2"></i>
                            Failed to load marketplace: ${error.message}
                        </div>
                    </div>
                `;
            }
        }

        async function loadChainNFTs(chainId) {
            const chain = CHAINS[chainId];
            if (!chain || !chain.nft) {
                return [];
            }
            
            try {
                const provider = new ethers.providers.JsonRpcProvider(chain.rpcUrl);
                const nftContract = new ethers.Contract(chain.nft, NFT_ABI, provider);
                
                // Try different methods to get NFTs
                let nfts = [];
                
                try {
                    // Method 1: Try to get totalSupply and iterate
                    const totalSupply = await nftContract.totalSupply();
                    const total = parseInt(totalSupply.toString());
                    
                    for (let i = 0; i < Math.min(total, 20); i++) { // Limit to 20 for performance
                        try {
                            const tokenId = await nftContract.tokenByIndex(i);
                            const owner = await nftContract.ownerOf(tokenId);
                            
                            // Get strategy data
                            let strategyData = "Unknown Strategy";
                            try {
                                strategyData = await nftContract.strategy(tokenId);
                            } catch (e) {
                                console.log(`Could not get strategy data for token ${tokenId}:`, e);
                            }
                            
                            // Parse strategy data
                            const [name, ratios] = strategyData.split('|');
                            const ratioParts = ratios ? ratios.split(',') : [];
                            
                            let monPercent = 50, musdPercent = 50;
                            ratioParts.forEach(part => {
                                if (part.includes('MON:')) monPercent = parseInt(part.split(':')[1]) || 50;
                                if (part.includes('mUSD:')) musdPercent = parseInt(part.split(':')[1]) || 50;
                                if (part.includes('HSK:')) monPercent = parseInt(part.split(':')[1]) || 50;
                                if (part.includes('hskUSD:')) musdPercent = parseInt(part.split(':')[1]) || 50;
                            });
                            
                            nfts.push({
                                tokenId: tokenId.toString(),
                                name: name || `Strategy ${tokenId}`,
                                monPercent: monPercent,
                                musdPercent: musdPercent,
                                owner: owner,
                                chainId: chainId
                            });
                        } catch (e) {
                            console.log(`Error loading token ${i}:`, e);
                        }
                    }
                } catch (e) {
                    console.log('Alternative NFT loading method failed:', e);
                    
                    // Method 2: Try to get nextId
                    try {
                        const nextId = await nftContract.nextId();
                        const total = parseInt(nextId.toString());
                        
                        for (let i = 1; i < Math.min(total, 20); i++) {
                            try {
                                const owner = await nftContract.ownerOf(i);
                                let strategyData = "Unknown Strategy";
                                try {
                                    strategyData = await nftContract.strategy(i);
                                } catch (e) {
                                    // Skip if no strategy data
                                }
                                
                                const [name, ratios] = strategyData.split('|');
                                
                                nfts.push({
                                    tokenId: i.toString(),
                                    name: name || `Strategy ${i}`,
                                    monPercent: 50,
                                    musdPercent: 50,
                                    owner: owner,
                                    chainId: chainId
                                });
                            } catch (e) {
                                // Token doesn't exist or other error, skip
                            }
                        }
                    } catch (e2) {
                        console.log('Second NFT loading method also failed:', e2);
                    }
                }
                
                // If still no NFTs, create some mock data for demonstration
                if (nfts.length === 0) {
                    nfts = createMockNFTs(chainId);
                }
                
                return nfts;
                
            } catch (error) {
                console.error(`Failed to load NFTs from chain ${chainId}:`, error);
                // Return mock data if real loading fails
                return createMockNFTs(chainId);
            }
        }

        function createMockNFTs(chainId) {
            const chain = CHAINS[chainId];
            const mockNFTs = [];
            const strategies = [
                { name: "Balanced Portfolio", mon: 50, musd: 50 },
                { name: "Growth Strategy", mon: 70, musd: 30 },
                { name: "Conservative Approach", mon: 30, musd: 70 },
                { name: "Cross-Chain Arbitrage", mon: 60, musd: 40 },
                { name: "AI Optimized", mon: 55, musd: 45 }
            ];
            
            for (let i = 1; i <= 5; i++) {
                const strategy = strategies[i % strategies.length];
                mockNFTs.push({
                    tokenId: i.toString(),
                    name: `${strategy.name} #${i}`,
                    monPercent: strategy.mon,
                    musdPercent: strategy.musd,
                    owner: "0x" + "1234567890abcdef".substring(0, 40),
                    chainId: chainId,
                    isMock: true
                });
            }
            
            return mockNFTs;
        }

        function displayAllChainNFTs(nfts) {
            const marketplace = document.getElementById('marketplace');
            
            if (nfts.length === 0) {
                marketplace.innerHTML = `
                    <div class="col-12">
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            No NFTs found matching the criteria
                        </div>
                    </div>
                `;
                return;
            }
            
            // Apply filters
            let filteredNFTs = [...nfts];
            const chainFilter = document.getElementById('nftChainFilter').value;
            const strategyFilter = document.getElementById('nftStrategyFilter').value;
            const searchInput = document.getElementById('nftSearchInput').value.toLowerCase();
            
            if (chainFilter !== 'all') {
                filteredNFTs = filteredNFTs.filter(nft => nft.chainId.toString() === chainFilter);
            }
            
            if (strategyFilter === 'cross_chain') {
                filteredNFTs = filteredNFTs.filter(nft => 
                    nft.name && nft.name.toLowerCase().includes('cross-chain')
                );
            } else if (strategyFilter === 'ai_generated') {
                filteredNFTs = filteredNFTs.filter(nft => 
                    nft.name && (nft.name.toLowerCase().includes('ai') || nft.name.toLowerCase().includes('optimized'))
                );
            }
            
            if (searchInput) {
                filteredNFTs = filteredNFTs.filter(nft => 
                    (nft.name && nft.name.toLowerCase().includes(searchInput)) ||
                    (nft.owner && nft.owner.toLowerCase().includes(searchInput)) ||
                    (nft.tokenId && nft.tokenId.includes(searchInput))
                );
            }
            
            if (filteredNFTs.length === 0) {
                marketplace.innerHTML = `
                    <div class="col-12">
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            No NFTs found matching the search criteria
                        </div>
                    </div>
                `;
                return;
            }
            
            // Sort by tokenId (newest first)
            filteredNFTs.sort((a, b) => parseInt(b.tokenId) - parseInt(a.tokenId));
            
            let html = '';
            filteredNFTs.forEach(nft => {
                const chain = CHAINS[nft.chainId];
                const chainBadgeClass = getChainBadgeClass(nft.chainId);
                const isOwner = userAddress && nft.owner.toLowerCase() === userAddress.toLowerCase();
                const isCrossChain = nft.name && nft.name.toLowerCase().includes('cross-chain');
                
                html += `
                    <div class="col-lg-4 col-md-6">
                        <div class="nft-market-item">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <div>
                                    <h6 class="mb-1">${nft.name} 
                                        ${isOwner ? '<span class="badge bg-primary ms-1">Mine</span>' : ''}
                                        ${isCrossChain ? '<span class="badge bg-info ms-1">Cross-Chain</span>' : ''}
                                    </h6>
                                    <div class="d-flex align-items-center mt-1">
                                        <span class="nft-id">ID: ${nft.tokenId}</span>
                                        <span class="nft-chain-badge" style="background-color: ${chain.color || '#666'}">
                                            <i class="fas fa-${getChainIcon(nft.chainId)} me-1"></i>${chain.symbol}
                                        </span>
                                        ${nft.isMock ? '<span class="badge bg-secondary ms-1">Demo</span>' : ''}
                                    </div>
                                    <div class="small text-muted mt-1">
                                        <i class="fas fa-user me-1"></i>${shortenAddress(nft.owner)}
                                    </div>
                                </div>
                            </div>
                            <div class="small">
                                <div class="mb-2">
                                    <div class="progress" style="height: 8px;">
                                        <div class="progress-bar" style="width: ${nft.monPercent}%; background-color: ${chain.color || '#7c3aed'}"></div>
                                        <div class="progress-bar bg-success" style="width: ${nft.musdPercent}%"></div>
                                    </div>
                                    <div class="d-flex justify-content-between small mt-1">
                                        <span>${chain.nativeToken}: ${nft.monPercent}%</span>
                                        <span>${chain.stableToken ? chain.stableToken.symbol : 'Stable'}: ${nft.musdPercent}%</span>
                                    </div>
                                </div>
                            </div>
                            <div class="nft-strategy-actions">
                                <button class="btn btn-sm btn-outline-light" onclick="showNFTDetails(${nft.chainId}, '${nft.tokenId}')">
                                    <i class="fas fa-info-circle me-1"></i>Details
                                </button>
                                <button class="btn btn-sm btn-outline-primary" onclick="useNFTStrategy(${nft.chainId}, '${nft.tokenId}')">
                                    <i class="fas fa-copy me-1"></i>Use
                                </button>
                                <button class="btn btn-sm btn-success" onclick="executeNFTStrategy(${nft.chainId}, '${nft.tokenId}')">
                                    <i class="fas fa-play me-1"></i>Execute
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            marketplace.innerHTML = html;
        }

        function searchAllChainNFTs() {
            const searchInput = document.getElementById('nftSearchInput').value.toLowerCase();
            const chainFilter = document.getElementById('nftChainFilter').value;
            const strategyFilter = document.getElementById('nftStrategyFilter').value;
            
            let filteredNFTs = [...allChainNFTs];
            
            // Apply filters
            if (chainFilter !== 'all') {
                filteredNFTs = filteredNFTs.filter(nft => nft.chainId.toString() === chainFilter);
            }
            
            if (strategyFilter === 'cross_chain') {
                filteredNFTs = filteredNFTs.filter(nft => 
                    nft.name && nft.name.toLowerCase().includes('cross-chain')
                );
            } else if (strategyFilter === 'ai_generated') {
                filteredNFTs = filteredNFTs.filter(nft => 
                    nft.name && (nft.name.toLowerCase().includes('ai') || nft.name.toLowerCase().includes('optimized'))
                );
            }
            
            if (searchInput) {
                filteredNFTs = filteredNFTs.filter(nft => 
                    (nft.name && nft.name.toLowerCase().includes(searchInput)) ||
                    (nft.owner && nft.owner.toLowerCase().includes(searchInput)) ||
                    (nft.tokenId && nft.tokenId.includes(searchInput))
                );
            }
            
            displayAllChainNFTs(filteredNFTs);
        }

        // ========== Cross-Chain AI Strategy Generation ==========
        async function generateCrossChainAIStrategy() {
            if (!userAddress) {
                alert('Please connect your wallet first');
                return;
            }
            
            const apiKey = document.getElementById('groqApiKey').value.trim();
            if (!apiKey) {
                alert('Please enter your Groq API key');
                return;
            }
            
            try {
                document.getElementById('crossChainAIResults').innerHTML = `
                    <div class="alert alert-info">
                        <span class="loading"></span> AI is analyzing your cross-chain portfolio and generating strategy...
                    </div>
                `;
                
                // Get current cross-chain asset data
                let totalValue = 0;
                let chainDetails = [];
                
                allChainAssets.forEach(asset => {
                    totalValue += asset.chainValue;
                    chainDetails.push({
                        chain: asset.chainName,
                        native: asset.nativeAmount,
                        stable: asset.stableBalance,
                        total: asset.chainValue,
                        percent: totalValue > 0 ? (asset.chainValue / totalValue * 100).toFixed(1) : 0
                    });
                });
                
                const goal = document.getElementById('investmentGoal').value;
                const risk = document.getElementById('riskTolerance').value;
                const model = document.getElementById('groqModel').value;
                const timeHorizon = document.getElementById('timeHorizon').value;
                const focusArea = document.getElementById('focusArea').value;
                const additionalPrompt = document.getElementById('additionalPrompt').value;
                
                // Create prompt for Groq
                let prompt = `You are an expert cross-chain crypto portfolio manager. Please suggest a cross-chain asset allocation strategy with the following characteristics:

Cross-Chain Portfolio Summary:
- Total Value: ${totalValue.toFixed(4)}
- Number of Chains: ${allChainAssets.length}

Current Chain Holdings:`;
                
                chainDetails.forEach(detail => {
                    prompt += `\n- ${detail.chain}: ${detail.total.toFixed(4)} (${detail.percent}%) [Native: ${detail.native.toFixed(4)}, Stable: ${detail.stable.toFixed(4)}]`;
                });

                prompt += `

Investment Goal: ${goal}
Risk Tolerance: ${risk}
Time Horizon: ${timeHorizon}
Focus Area: ${focusArea}`;

                if (additionalPrompt.trim() !== '') {
                    prompt += `\n\nAdditional context: ${additionalPrompt}`;
                }

                prompt += `\n\nPlease provide a cross-chain allocation strategy with:
1. Recommended allocation percentages for each chain
2. Recommended native/stablecoin mix for each chain
3. Brief explanation of your cross-chain strategy
4. Risk assessment and expected returns
5. Any rebalancing actions needed between chains

Respond in a structured format with clear recommendations for each chain.`;

                // Call Groq API
                const response = await fetch("https://api.groq.com/openai/v1/chat/completions", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "Authorization": `Bearer ${apiKey}`
                    },
                    body: JSON.stringify({
                        model: model,
                        messages: [{ role: "user", content: prompt }],
                        temperature: 0.7,
                        max_tokens: 1000
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`Groq API request failed: ${response.status} ${response.statusText}`);
                }
                
                const data = await response.json();
                const aiResponse = data.choices[0].message.content;
                
                // Parse AI response
                window.crossChainAIStrategy = {
                    response: aiResponse,
                    recommendations: parseCrossChainAIResponse(aiResponse)
                };
                
                // Display results
                document.getElementById('crossChainAIResults').innerHTML = `
                    <div class="alert alert-success">
                        <h6><i class="fas fa-robot me-2"></i>AI Cross-Chain Strategy Recommendation</h6>
                        <div class="ai-response mt-2">
                            ${aiResponse}
                        </div>
                    </div>
                `;
                
                // Display apply suggestion
                document.getElementById('crossChainAISuggestions').innerHTML = `
                    <div class="ai-suggestion" onclick="applyCrossChainAISuggestion()">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6><i class="fas fa-lightbulb me-2"></i>AI Cross-Chain Configuration</h6>
                                <p class="mb-0">AI-generated cross-chain allocation strategy</p>
                                <small class="text-muted">Click to apply this configuration to the strategy builder</small>
                            </div>
                            <button class="btn btn-sm btn-primary">
                                Apply Configuration
                            </button>
                        </div>
                    </div>
                `;
                
            } catch (error) {
                console.error('AI request failed:', error);
                document.getElementById('crossChainAIResults').innerHTML = `
                    <div class="alert alert-danger">
                        <h6><i class="fas fa-exclamation-triangle me-2"></i>AI Request Failed</h6>
                        <p>${error.message}</p>
                        ${error.message.includes('401') ? '<p class="small">Please check your API key</p>' : ''}
                        ${error.message.includes('429') ? '<p class="small">Rate limit exceeded. Please try again later.</p>' : ''}
                    </div>
                `;
            }
        }

        function parseCrossChainAIResponse(response) {
            // Simple parsing - in reality this would be more sophisticated
            const recommendations = {};
            const lines = response.split('\n');
            
            allChainAssets.forEach(asset => {
                const chainName = asset.chainName;
                for (let line of lines) {
                    if (line.toLowerCase().includes(chainName.toLowerCase()) && line.includes('%')) {
                        const match = line.match(/(\d+)%/);
                        if (match) {
                            recommendations[asset.chainId] = parseInt(match[1]);
                            break;
                        }
                    }
                }
            });
            
            return recommendations;
        }

        function applyCrossChainAISuggestion() {
            if (!window.crossChainAIStrategy) {
                alert('Please generate AI suggestion first');
                return;
            }
            
            // Apply AI recommendations to allocation
            if (window.crossChainAIStrategy.recommendations) {
                Object.keys(window.crossChainAIStrategy.recommendations).forEach(chainId => {
                    crossChainAllocation[chainId] = window.crossChainAIStrategy.recommendations[chainId];
                });
            }
            
            // Update strategy name
            document.getElementById('crossChainStrategyName').value = 'AI Cross-Chain Strategy';
            
            // Update UI
            updateCrossChainAllocationInputs();
            
            alert('Applied AI cross-chain strategy suggestion');
        }

        function executeCrossChainStrategy() {
            if (!userAddress) {
                alert('Please connect your wallet first');
                return;
            }
            
            // Check if we have a valid allocation
            let total = 0;
            Object.values(crossChainAllocation).forEach(val => {
                total += val || 0;
            });
            
            if (total !== 100) {
                alert(`Total allocation must be 100%, current is ${total}%. Please adjust the allocations.`);
                return;
            }
            
            const strategyName = document.getElementById('crossChainStrategyName').value || "Cross-Chain Strategy";
            
            // Show confirmation
            let confirmMessage = `Execute cross-chain strategy "${strategyName}"?\n\nAllocation:\n`;
            
            allChainAssets.forEach(asset => {
                const percent = crossChainAllocation[asset.chainId] || 0;
                if (percent > 0) {
                    confirmMessage += `${asset.chainName}: ${percent}%\n`;
                }
            });
            
            confirmMessage += "\nThis will rebalance your portfolio across all chains.";
            
            if (!confirm(confirmMessage)) return;
            
            // Execute strategy
            alert(`Cross-chain strategy "${strategyName}" execution started.\n\nNote: Full cross-chain execution would involve transactions on multiple chains.`);
        }

        function mintCrossChainStrategyNFT() {
            if (!userAddress) {
                alert('Please connect your wallet first');
                return;
            }
            
            const strategyName = document.getElementById('crossChainStrategyName').value || "Cross-Chain Strategy";
            const strategyType = document.getElementById('strategyType').value;
            
            // Check if we're on a chain with NFT contract
            const currentChain = CHAINS[currentChainId];
            if (!currentChain || !currentChain.nft) {
                alert(`Cannot mint NFT on ${currentChain ? currentChain.name : 'current chain'}. Please switch to HashKey Chain or Monad Testnet.`);
                return;
            }
            
            // Create strategy data
            let strategyData = `${strategyName}|Type:${strategyType}`;
            
            // Add allocation data
            allChainAssets.forEach(asset => {
                const percent = crossChainAllocation[asset.chainId] || 0;
                if (percent > 0) {
                    strategyData += `,${asset.chainName}:${percent}`;
                }
            });
            
            const statusDiv = document.getElementById('crossChainMintStatus');
            
            // This would normally mint an NFT, but for demo we'll simulate it
            statusDiv.innerHTML = `
                <div class="alert alert-success">
                    <i class="fas fa-check-circle me-2"></i>Strategy ready to mint as NFT!
                    <p class="mb-0 small">Strategy: ${strategyName}</p>
                    <p class="mb-0 small">Data: ${strategyData.substring(0, 100)}...</p>
                    <p class="mb-0 small">Chain: ${currentChain.name}</p>
                    <button class="btn btn-sm btn-primary mt-2" onclick="simulateMintNFT('${strategyData}')">
                        Simulate Mint
                    </button>
                </div>
            `;
        }

        function simulateMintNFT(strategyData) {
            alert(`NFT minting simulated for strategy:\n\n${strategyData}\n\nIn a real implementation, this would create an on-chain NFT.`);
            
            // Refresh NFT list
            setTimeout(() => {
                loadAllChainNFTs();
            }, 1000);
        }

        // ========== Helper Functions ==========
        function getChainBadgeClass(chainId) {
            switch(parseInt(chainId)) {
                case 133: return 'hashkey';
                case 10143: return 'monad';
                case 1287: return 'moonbase';
                case 11155111: return 'sepolia';
                default: return '';
            }
        }

        function getChainIcon(chainId) {
            switch(parseInt(chainId)) {
                case 133: return 'fire';
                case 10143: return 'bolt';
                case 1287: return 'moon';
                case 11155111: return 'ethereum';
                default: return 'link';
            }
        }

        function getAssetIconClass(assetSymbol) {
            switch(assetSymbol.toLowerCase()) {
                case 'hsk': return 'hsk';
                case 'mon': return 'mon';
                case 'dev': return 'dev';
                case 'sepoliaeth': return 'sepeth';
                case 'hskusd': return 'hskusd';
                case 'musd': return 'musd';
                default: return '';
            }
        }

        function getAssetIcon(assetSymbol) {
            switch(assetSymbol.toLowerCase()) {
                case 'hsk': return 'fire';
                case 'mon': return 'bolt';
                case 'dev': return 'moon';
                case 'sepoliaeth': return 'ethereum';
                case 'hskusd': return 'coins';
                case 'musd': return 'coins';
                default: return 'coins';
            }
        }

        function shortenAddress(address) {
            if (!address) return '';
            return `${address.substring(0, 6)}...${address.substring(address.length - 4)}`;
        }

        function switchTab(tabId) {
            const tabElement = document.querySelector(`[data-bs-target="#${tabId}"]`);
            if (tabElement) {
                new bootstrap.Tab(tabElement).show();
                
                // Refresh data based on tab
                if (tabId === 'portfolio') {
                    setTimeout(() => {
                        loadMultiChainAssets();
                    }, 300);
                }
                
                if (tabId === 'strategyBuilder') {
                    setTimeout(() => {
                        updateCrossChainAllocationInputs();
                    }, 300);
                }
                
                if (tabId === 'nftMarket') {
                    setTimeout(() => {
                        loadAllChainNFTs();
                    }, 300);
                }
                
                if (tabId === 'dex') {
                    // Initialize DEX tab
                    if (selectedDexChain) {
                        loadDexInterface(selectedDexChain);
                    }
                }
            }
        }

        function setActiveChain(chainId) {
            activeChainFilter = chainId;
            
            // Update UI
            document.querySelectorAll('.network-selector .btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            if (chainId === 'all') {
                document.querySelector('.network-selector .btn:nth-child(1)').classList.add('active');
            } else {
                document.querySelectorAll('.network-selector .btn').forEach(btn => {
                    if (btn.textContent.includes(CHAINS[chainId]?.name || '')) {
                        btn.classList.add('active');
                    }
                });
            }
            
            // Reload assets with filter
            if (userAddress) {
                loadMultiChainAssets();
            }
        }

        function showAssetType(type) {
            activeAssetType = type;
            
            // Update UI
            document.querySelectorAll('.asset-type-tabs .btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Update display
            updateMultiChainAssetsDisplay();
        }

        function updateSystemStatus() {
            const statusDiv = document.getElementById('systemStatus');
            
            if (!userAddress) {
                statusDiv.innerHTML = `
                    <div class="alert alert-dark">
                        <i class="fas fa-info-circle me-2"></i>
                        Connect wallet to check system status
                    </div>
                `;
                return;
            }
            
            let statusHTML = `
                <div class="alert alert-success">
                    <i class="fas fa-check-circle me-2"></i>
                    Connected to ${CHAINS[currentChainId]?.name || 'Unknown Network'}
                </div>
            `;
            
            statusHTML += `
                <div class="alert ${allChainAssets.length > 0 ? 'alert-success' : 'alert-warning'}">
                    <i class="fas fa-${allChainAssets.length > 0 ? 'check' : 'exclamation'}-circle me-2"></i>
                    ${allChainAssets.length} chains with assets
                </div>
            `;
            
            statusHTML += `
                <div class="alert ${allChainNFTs.length > 0 ? 'alert-success' : 'alert-info'}">
                    <i class="fas fa-${allChainNFTs.length > 0 ? 'check' : 'info'}-circle me-2"></i>
                    ${allChainNFTs.length} NFT strategies available
                </div>
            `;
            
            statusDiv.innerHTML = statusHTML;
        }

        function updateStrategyTypeConfig() {
            updateCrossChainAllocationInputs();
        }

        function showCrossChainRebalanceModal() {
            if (!userAddress) {
                alert('Please connect your wallet first');
                return;
            }
            
            const modal = new bootstrap.Modal(document.getElementById('crossChainRebalanceModal'));
            updateCrossChainRebalancePreview();
            modal.show();
        }

        function updateCrossChainRebalancePreview() {
            const strategy = document.getElementById('crossChainRebalanceStrategy').value;
            const previewDiv = document.getElementById('crossChainRebalancePreview');
            const customDiv = document.getElementById('crossChainCustomAllocation');
            
            if (strategy === 'custom') {
                customDiv.style.display = 'block';
                // Generate custom allocation inputs
                let inputsHTML = '';
                allChainAssets.forEach(asset => {
                    inputsHTML += `
                        <div class="percentage-control mb-2">
                            <label class="form-label">${asset.chainName}</label>
                            <div class="slider-container">
                                <input type="range" class="form-range" 
                                       id="rebalance-${asset.chainId}" 
                                       min="0" max="100" value="0">
                            </div>
                            <div class="input-container">
                                <input type="number" class="form-control" 
                                       id="rebalance-input-${asset.chainId}" 
                                       value="0" min="0" max="100">
                            </div>
                            <span>%</span>
                        </div>
                    `;
                });
                document.getElementById('crossChainCustomAllocationInputs').innerHTML = inputsHTML;
            } else {
                customDiv.style.display = 'none';
            }
            
            // Generate preview based on strategy
            let previewHTML = '<div class="alert alert-info"><h6>Rebalancing Preview</h6>';
            
            if (strategy === 'balanced') {
                previewHTML += '<p>Will distribute assets equally across all chains</p>';
            } else if (strategy === 'risk_based') {
                previewHTML += '<p>Will allocate based on chain risk profiles</p>';
            } else if (strategy === 'performance') {
                previewHTML += '<p>Will optimize based on historical performance</p>';
            } else {
                previewHTML += '<p>Custom allocation will be applied</p>';
            }
            
            previewHTML += '</div>';
            previewDiv.innerHTML = previewHTML;
        }

        function executeCrossChainRebalanceFromModal() {
            alert('Cross-chain rebalancing would execute transactions across multiple chains. This is a complex operation that would require bridge integrations in a real implementation.');
            
            // Close modal
            bootstrap.Modal.getInstance(document.getElementById('crossChainRebalanceModal')).hide();
        }

        function showTradeAllModal() {
            alert('Cross-chain trading interface would allow trading assets between different chains using bridges.');
        }

        function optimizeCrossChainAllocation() {
            // Simple optimization: favor chains with DEX for better liquidity
            let optimized = {};
            let totalWeight = 0;
            
            allChainAssets.forEach(asset => {
                // Give higher weight to chains with DEX
                const weight = asset.hasDex ? 2 : 1;
                optimized[asset.chainId] = weight;
                totalWeight += weight;
            });
            
            // Convert to percentages
            Object.keys(optimized).forEach(chainId => {
                optimized[chainId] = Math.round((optimized[chainId] / totalWeight) * 100);
            });
            
            // Adjust to make sure total is 100
            let currentTotal = Object.values(optimized).reduce((sum, val) => sum + val, 0);
            if (currentTotal !== 100) {
                const firstChain = Object.keys(optimized)[0];
                optimized[firstChain] += (100 - currentTotal);
            }
            
            // Apply optimized allocation
            crossChainAllocation = optimized;
            updateCrossChainAllocationInputs();
            
            alert('Cross-chain allocation optimized! Chains with DEX support given higher allocation for better liquidity.');
        }

        function generateQuickStrategy() {
            // Generate a simple balanced strategy
            const chainCount = allChainAssets.length;
            if (chainCount === 0) return;
            
            const equalPercent = Math.floor(100 / chainCount);
            let allocation = {};
            let remainder = 100;
            
            allChainAssets.forEach((asset, index) => {
                let percent = index === chainCount - 1 ? remainder : equalPercent;
                allocation[asset.chainId] = percent;
                remainder -= percent;
            });
            
            crossChainAllocation = allocation;
            document.getElementById('crossChainStrategyName').value = 'Quick Balanced Strategy';
            updateCrossChainAllocationInputs();
            
            switchTab('strategyBuilder');
            alert('Quick balanced strategy generated!');
        }

        function mintCurrentCrossChainStrategy() {
            switchTab('strategyBuilder');
            setTimeout(() => {
                document.getElementById('crossChainStrategyName').focus();
            }, 500);
        }

        function toggleApiKeyVisibility() {
            const apiKeyInput = document.getElementById('groqApiKey');
            const toggleBtn = document.querySelector('.toggle-visibility i');
            
            if (apiKeyInput.type === 'password') {
                apiKeyInput.type = 'text';
                toggleBtn.className = 'fas fa-eye-slash';
            } else {
                apiKeyInput.type = 'password';
                toggleBtn.className = 'fas fa-eye';
            }
        }

        async function claimTestTokens() {
            if (!userAddress) {
                alert('Please connect your wallet first');
                return;
            }
            
            try {
                document.getElementById('walletInfo').innerHTML = '<span class="loading"></span> Getting faucet info...';
                
                // Open appropriate faucet based on current chain
                const currentChain = CHAINS[currentChainId];
                if (currentChain) {
                    if (currentChainId === 133) {
                        window.open('https://testnet.hsk.xyz/', '_blank');
                        alert(`Please visit HashKey Chain faucet and enter your address:\n${userAddress}`);
                    } else if (currentChainId === 10143) {
                        window.open('https://testnet.monad.xyz/', '_blank');
                        alert(`Please visit Monad faucet and enter your address:\n${userAddress}`);
                    } else if (currentChainId === 1287) {
                        window.open('https://faucet.moonbeam.network/', '_blank');
                        alert(`Please visit Moonbase Alpha faucet and enter your address:\n${userAddress}`);
                    } else if (currentChainId === 11155111) {
                        window.open('https://sepoliafaucet.com/', '_blank');
                        alert(`Please visit Sepolia faucet and enter your address:\n${userAddress}`);
                    } else {
                        alert('No faucet available for current network');
                    }
                }
                
                // Restore button status
                setTimeout(async () => {
                    if (provider && userAddress) {
                        const balance = await provider.getBalance(userAddress);
                        const nativeBalance = parseFloat(ethers.utils.formatEther(balance));
                        const shortAddr = shortenAddress(userAddress);
                        const chain = CHAINS[currentChainId] || { nativeToken: 'ETH' };
                        
                        document.getElementById('walletInfo').innerHTML = `
                            <div class="dropdown">
                                <button class="btn btn-success dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                    <i class="fas fa-wallet me-2"></i>${shortAddr}
                                    <small class="d-block">${nativeBalance.toFixed(4)} ${chain.nativeToken}</small>
                                </button>
                            </div>
                        `;
                    }
                }, 3000);
                
            } catch (error) {
                console.error('Faucet request failed:', error);
                alert('Failed to open faucet, please manually visit faucet website');
            }
        }

        function showAllChainRebalance() {
            showCrossChainRebalanceModal();
        }

        // ========== NFT Functions ==========
        function showNFTDetails(chainId, tokenId) {
            // Find NFT
            const nft = allChainNFTs.find(n => n.chainId === chainId && n.tokenId === tokenId);
            if (!nft) {
                alert('NFT not found');
                return;
            }
            
            const chain = CHAINS[chainId];
            const modal = new bootstrap.Modal(document.getElementById('nftDetailsModal'));
            const content = document.getElementById('nftDetailsContent');
            
            content.innerHTML = `
                <div class="mb-3">
                    <h6>${nft.name}</h6>
                    <p class="small text-muted mb-1">Token ID: ${nft.tokenId}</p>
                    <p class="small text-muted mb-1">Chain: ${chain.name}</p>
                    <p class="small text-muted mb-3">Owner: ${shortenAddress(nft.owner)}</p>
                </div>
                
                <div class="mb-3">
                    <h6>Strategy Allocation</h6>
                    <div class="progress" style="height: 10px; margin-bottom: 10px;">
                        <div class="progress-bar" style="width: ${nft.monPercent}%; background-color: ${chain.color || '#7c3aed'}"></div>
                        <div class="progress-bar bg-success" style="width: ${nft.musdPercent}%"></div>
                    </div>
                    <div class="d-flex justify-content-between small">
                        <span>${chain.nativeToken}: ${nft.monPercent}%</span>
                        <span>${chain.stableToken ? chain.stableToken.symbol : 'Stable'}: ${nft.musdPercent}%</span>
                    </div>
                </div>
                
                ${nft.isMock ? '<div class="alert alert-warning small">This is a demo NFT for testing purposes.</div>' : ''}
                
                <div class="alert alert-info small">
                    <i class="fas fa-info-circle me-2"></i>
                    This NFT represents a rebalancing strategy that can be applied to your portfolio.
                </div>
            `;
            
            modal.show();
            
            // Store current NFT for use
            window.currentNFTForUse = { chainId, tokenId };
        }

        function useNFTFromDetails() {
            if (!window.currentNFTForUse) return;
            
            const { chainId, tokenId } = window.currentNFTForUse;
            useNFTStrategy(chainId, tokenId);
            
            // Close modal
            bootstrap.Modal.getInstance(document.getElementById('nftDetailsModal')).hide();
        }

        function useNFTStrategy(chainId, tokenId) {
            const nft = allChainNFTs.find(n => n.chainId === chainId && n.tokenId === tokenId);
            if (!nft) {
                alert('NFT not found');
                return;
            }
            
            const chain = CHAINS[chainId];
            
            // Apply NFT strategy to current configuration
            crossChainAllocation = {};
            crossChainAllocation[chainId] = 100; // Focus on this chain for single-chain NFT
            
            // Update chain asset ratios
            if (!chainAssetRatios[chainId]) {
                chainAssetRatios[chainId] = { native: 50, stable: 50 };
            }
            chainAssetRatios[chainId].native = nft.monPercent;
            chainAssetRatios[chainId].stable = nft.musdPercent;
            
            // Update UI
            document.getElementById('crossChainStrategyName').value = `NFT: ${nft.name}`;
            updateCrossChainAllocationInputs();
            updateMultiChainAssetsDisplay();
            updateChainRatioControls();
            
            alert(`Applied NFT strategy "${nft.name}" to configuration`);
            
            // Switch to strategy builder tab
            switchTab('strategyBuilder');
        }

        function executeNFTStrategy(chainId, tokenId) {
            const nft = allChainNFTs.find(n => n.chainId === chainId && n.tokenId === tokenId);
            if (!nft) {
                alert('NFT not found');
                return;
            }
            
            const chain = CHAINS[chainId];
            const confirmMessage = `Execute NFT strategy "${nft.name}"?\n\nAllocation: ${nft.monPercent}% ${chain.nativeToken}, ${nft.musdPercent}% ${chain.stableToken ? chain.stableToken.symbol : 'Stable'}\n\nThis will rebalance your portfolio on ${chain.name} to match this strategy.`;
            
            if (confirm(confirmMessage)) {
                alert(`Executing NFT strategy "${nft.name}" on ${chain.name}...\n\nNote: This would execute trades to match the target allocation.`);
            }
        }

        // ========== Wallet Listeners ==========
        if (window.ethereum) {
            ethereum.on('accountsChanged', (accounts) => {
                if (accounts.length > 0) {
                    location.reload();
                } else {
                    userAddress = null;
                    document.getElementById('walletInfo').innerHTML = `
                        <button class="btn btn-primary" onclick="connectWallet()">
                            <i class="fas fa-wallet me-2"></i>Connect Wallet
                        </button>
                    `;
                }
            });
            
            ethereum.on('chainChanged', () => {
                location.reload();
            });
        }
    </script>
</body>
</html>
